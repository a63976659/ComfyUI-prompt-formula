# 新增节点文件：Wan26多镜头.py

import re
from 常量配置 import *
from 工具函数 import clean_text

class Wan26多镜头:
    @classmethod
    def INPUT_TYPES(cls):
        return {
            "required": {
                "总体描述": ("STRING", {
                    "multiline": True,
                    "default": "这个故事以第三人称视角，讲述了一个关于放弃与重拾希望的短剧。",
                    "display_name": "总体描述"
                }),
                "镜头数量": ("INT", {
                    "default": 3,
                    "min": 1,
                    "max": 5,
                    "step": 1,
                    "display": "slider",
                    "display_name": "镜头数量"
                }),
                "启用智能多镜": ("BOOLEAN", {
                    "default": False,
                    "display_name": "启用智能多镜"
                }),
            },
            "optional": {
                # 镜头1
                "镜头1开始时间": ("STRING", {
                    "multiline": False,
                    "default": "0秒",
                    "display_name": "镜头1开始时间"
                }),
                "镜头1结束时间": ("STRING", {
                    "multiline": False,
                    "default": "3秒",
                    "display_name": "镜头1结束时间"
                }),
                "镜头1运镜方式": (CAMERA_MOVEMENTS, {
                    "default": "无",
                    "display_name": "镜头1运镜方式"
                }),
                "镜头1描述": ("STRING", {
                    "multiline": True,
                    "default": "一个男孩在操场的角落独自坐着，低头望着手中的信纸，随后轻轻叹气，眼神中透露出迷茫。",
                    "display_name": "镜头1描述"
                }),
                
                # 镜头2
                "镜头2开始时间": ("STRING", {
                    "multiline": False,
                    "default": "4秒",
                    "display_name": "镜头2开始时间"
                }),
                "镜头2结束时间": ("STRING", {
                    "multiline": False,
                    "default": "6秒",
                    "display_name": "镜头2结束时间"
                }),
                "镜头2运镜方式": (CAMERA_MOVEMENTS, {
                    "default": "固定镜头",
                    "display_name": "镜头2运镜方式"
                }),
                "镜头2描述": ("STRING", {
                    "multiline": True,
                    "default": "硬切转场，固定机位，聚焦于男孩的眼睛，泪光闪烁，带着失落和无助。",
                    "display_name": "镜头2描述"
                }),
                
                # 镜头3
                "镜头3开始时间": ("STRING", {
                    "multiline": False,
                    "default": "7秒",
                    "display_name": "镜头3开始时间"
                }),
                "镜头3结束时间": ("STRING", {
                    "multiline": False,
                    "default": "10秒",
                    "display_name": "镜头3结束时间"
                }),
                "镜头3运镜方式": (CAMERA_MOVEMENTS, {
                    "default": "无",
                    "display_name": "镜头3运镜方式"
                }),
                "镜头3描述": ("STRING", {
                    "multiline": True,
                    "default": "硬切转场，场景转至一间简朴的教室。一个女孩眼神温和而坚定，穿着朴素的衣着，面带温和而坚定的笑容，走到男孩的身边安慰他。",
                    "display_name": "镜头3描述"
                }),
                
                # 镜头4 (当镜头数量>=4时显示)
                "镜头4开始时间": ("STRING", {
                    "multiline": False,
                    "default": "11秒",
                    "display_name": "镜头4开始时间"
                }),
                "镜头4结束时间": ("STRING", {
                    "multiline": False,
                    "default": "13秒",
                    "display_name": "镜头4结束时间"
                }),
                "镜头4运镜方式": (CAMERA_MOVEMENTS, {
                    "default": "无",
                    "display_name": "镜头4运镜方式"
                }),
                "镜头4描述": ("STRING", {
                    "multiline": True,
                    "default": "",
                    "display_name": "镜头4描述"
                }),
                
                # 镜头5 (当镜头数量>=5时显示)
                "镜头5开始时间": ("STRING", {
                    "multiline": False,
                    "default": "14秒",
                    "display_name": "镜头5开始时间"
                }),
                "镜头5结束时间": ("STRING", {
                    "multiline": False,
                    "default": "16秒",
                    "display_name": "镜头5结束时间"
                }),
                "镜头5运镜方式": (CAMERA_MOVEMENTS, {
                    "default": "无",
                    "display_name": "镜头5运镜方式"
                }),
                "镜头5描述": ("STRING", {
                    "multiline": True,
                    "default": "",
                    "display_name": "镜头5描述"
                }),
                
                # 通用参数
                "转场效果": (["硬切转场", "淡入淡出", "交叉溶解", "滑动转场", "无"], {
                    "default": "硬切转场",
                    "display_name": "转场效果"
                }),
                "时间格式": (["秒", "帧"], {
                    "default": "秒",
                    "display_name": "时间格式"
                }),
                "视频总时长": ("FLOAT", {
                    "default": 15.0,
                    "min": 1.0,
                    "max": 15.0,
                    "step": 1.0,
                    "display": "slider",
                    "display_name": "视频总时长"
                }),
                "附加指令": ("STRING", {
                    "multiline": True,
                    "default": "保持画面主体、场景、氛围等关键信息的一致性，确保镜头间连贯叙事。",
                    "display_name": "附加指令"
                }),
            }
        }
    
    RETURN_TYPES = ("STRING", "STRING", "STRING")
    RETURN_NAMES = ("多镜头提示词", "完整提示词", "镜头结构表")
    FUNCTION = "生成多镜头提示词"
    CATEGORY = "📕提示词公式/图转视频"

    def 生成多镜头提示词(self, 总体描述, 镜头数量, 启用智能多镜,
                    # 镜头1
                    镜头1开始时间="0秒", 镜头1结束时间="3秒", 镜头1描述="", 镜头1运镜方式="无",
                    # 镜头2
                    镜头2开始时间="4秒", 镜头2结束时间="6秒", 镜头2描述="", 镜头2运镜方式="无",
                    # 镜头3
                    镜头3开始时间="7秒", 镜头3结束时间="10秒", 镜头3描述="", 镜头3运镜方式="无",
                    # 镜头4
                    镜头4开始时间="", 镜头4结束时间="", 镜头4描述="", 镜头4运镜方式="无",
                    # 镜头5
                    镜头5开始时间="", 镜头5结束时间="", 镜头5描述="", 镜头5运镜方式="无",
                    # 通用参数
                    转场效果="硬切转场", 时间格式="秒", 视频总时长="", 附加指令=""):
        
        try:
            # 清理输入文本
            总体描述清理 = clean_text(总体描述)
            附加指令清理 = clean_text(附加指令)
            
            # 如果启用智能多镜，生成简化版提示词
            if 启用智能多镜:
                return self._生成智能多镜提示词(总体描述清理, 附加指令清理)
            
            # 生成结构化多镜头提示词
            多镜头提示词, 镜头结构表 = self._生成结构化多镜头提示词(
                总体描述清理, 镜头数量,
                # 镜头数据
                镜头1开始时间, 镜头1结束时间, 镜头1描述, 镜头1运镜方式,
                镜头2开始时间, 镜头2结束时间, 镜头2描述, 镜头2运镜方式,
                镜头3开始时间, 镜头3结束时间, 镜头3描述, 镜头3运镜方式,
                镜头4开始时间, 镜头4结束时间, 镜头4描述, 镜头4运镜方式,
                镜头5开始时间, 镜头5结束时间, 镜头5描述, 镜头5运镜方式,
                转场效果, 时间格式
            )
            
            # 生成完整提示词
            完整提示词 = self._生成完整提示词(
                多镜头提示词, 总体描述清理, 附加指令清理, 视频总时长, 时间格式
            )
            
            return (多镜头提示词, 完整提示词, 镜头结构表)
            
        except Exception as e:
            import logging
            logging.error(f"Wan26多镜头生成错误: {str(e)}")
            error_msg = f"生成多镜头提示词时出错: {str(e)}"
            return (error_msg, error_msg, error_msg)

    def _生成智能多镜提示词(self, 总体描述, 附加指令):
        """生成智能多镜简化版提示词"""
        智能提示词 = f"{总体描述}\n\n请根据以上描述，智能生成一个包含3-5个镜头的连贯叙事视频。要求："
        
        要求列表 = [
            "保持画面主体、场景、氛围的一致性",
            "镜头间有自然的转场过渡",
            "每个镜头有明确的时间分配",
            "符合故事叙述的逻辑顺序"
        ]
        
        for 要求 in 要求列表:
            智能提示词 += f"\n- {要求}"
        
        if 附加指令:
            智能提示词 += f"\n\n附加要求：{附加指令}"
        
        return (智能提示词, 智能提示词, "智能多镜模式已启用")

    def _生成结构化多镜头提示词(self, 总体描述, 镜头数量,
                           镜头1开始时间, 镜头1结束时间, 镜头1描述, 镜头1运镜方式,
                           镜头2开始时间, 镜头2结束时间, 镜头2描述, 镜头2运镜方式,
                           镜头3开始时间, 镜头3结束时间, 镜头3描述, 镜头3运镜方式,
                           镜头4开始时间, 镜头4结束时间, 镜头4描述, 镜头4运镜方式,
                           镜头5开始时间, 镜头5结束时间, 镜头5描述, 镜头5运镜方式,
                           转场效果, 时间格式):
        """生成结构化多镜头提示词"""
        
        # 存储所有镜头数据
        镜头数据 = [
            {
                "序号": 1,
                "开始": clean_text(镜头1开始时间) or "0秒",
                "结束": clean_text(镜头1结束时间) or "3秒",
                "描述": clean_text(镜头1描述),
                "运镜": 镜头1运镜方式
            },
            {
                "序号": 2,
                "开始": clean_text(镜头2开始时间) or "4秒",
                "结束": clean_text(镜头2结束时间) or "6秒",
                "描述": clean_text(镜头2描述),
                "运镜": 镜头2运镜方式
            },
            {
                "序号": 3,
                "开始": clean_text(镜头3开始时间) or "7秒",
                "结束": clean_text(镜头3结束时间) or "10秒",
                "描述": clean_text(镜头3描述),
                "运镜": 镜头3运镜方式
            }
        ]
        
        # 添加镜头4（如果镜头数量>=4且描述不为空）
        if 镜头数量 >= 4:
            镜头4描述清理 = clean_text(镜头4描述)
            if 镜头4描述清理:
                镜头数据.append({
                    "序号": 4,
                    "开始": clean_text(镜头4开始时间) or "11秒",
                    "结束": clean_text(镜头4结束时间) or "13秒",
                    "描述": 镜头4描述清理,
                    "运镜": 镜头4运镜方式
                })
        
        # 添加镜头5（如果镜头数量>=5且描述不为空）
        if 镜头数量 >= 5:
            镜头5描述清理 = clean_text(镜头5描述)
            if 镜头5描述清理:
                镜头数据.append({
                    "序号": 5,
                    "开始": clean_text(镜头5开始时间) or "14秒",
                    "结束": clean_text(镜头5结束时间) or "16秒",
                    "描述": 镜头5描述清理,
                    "运镜": 镜头5运镜方式
                })
        
        # 生成多镜头提示词
        提示词组件 = []
        
        # 1. 总体描述
        if 总体描述:
            if not 总体描述.endswith(('。', '.', '!', '！', '?', '？')):
                总体描述 += '。'
            提示词组件.append(总体描述)
        
        # 2. 转场说明（如果不是第一个镜头）
        if 转场效果 and 转场效果 != "无" and len(镜头数据) > 1:
            提示词组件.append(f"镜头间使用{转场效果}。")
        
        # 3. 镜头描述
        for 镜头 in 镜头数据:
            if not 镜头["描述"]:
                continue
                
            # 构建时间戳
            时间戳 = self._构建时间戳(镜头["开始"], 镜头["结束"], 时间格式)
            
            # 构建镜头描述
            镜头描述文本 = 镜头["描述"]
            
            # 添加运镜效果（如果指定且不是"无"）
            if 镜头["运镜"] and 镜头["运镜"] != "无":
                运镜描述 = self._获取运镜描述(镜头["运镜"], "主体")
                if 运镜描述:
                    镜头描述文本 += f"，{运镜描述}"
            
            # 添加序号前缀
            序号前缀 = self._获取序号前缀(镜头["序号"])
            
            # 组合镜头描述
            镜头文本 = f"{序号前缀}{时间戳}{镜头描述文本}"
            提示词组件.append(镜头文本)
        
        # 组合所有组件
        多镜头提示词 = "\n".join(提示词组件)
        
        # 生成镜头结构表
        镜头结构表 = self._生成镜头结构表(镜头数据, 转场效果, 时间格式)
        
        return 多镜头提示词, 镜头结构表

    def _构建时间戳(self, 开始时间, 结束时间, 时间格式):
        """构建时间戳格式，如"[0-3秒]"或"[0-72帧]"（假设30fps）"""
        开始时间_清理 = 开始时间.replace("秒", "").replace("帧", "").strip()
        结束时间_清理 = 结束时间.replace("秒", "").replace("帧", "").strip()
        
        try:
            # 如果是帧格式，转换为秒显示
            if 时间格式 == "帧":
                # 假设30fps
                开始秒 = int(开始时间_清理) / 30
                结束秒 = int(结束时间_清理) / 30
                return f"[{开始秒:.1f}-{结束秒:.1f}秒]"
            else:
                return f"[{开始时间_清理}-{结束时间_清理}秒]"
        except:
            # 如果转换失败，返回原始格式
            return f"[{开始时间}-{结束时间}]"

    def _获取运镜描述(self, 运镜方式, 目标对象):
        """获取运镜方式的自然语言描述"""
        if not 运镜方式 or 运镜方式 == "无":
            return ""
        
        运镜描述 = CAMERA_MOVEMENT_DESCRIPTIONS.get(运镜方式, "")
        if not 运镜描述:
            return f"{运镜方式}"
        
        # 替换目标占位符
        if "{target}" in 运镜描述:
            运镜描述 = 运镜描述.replace("{target}", 目标对象)
        
        # 提取主要描述部分（去掉后面的速度等描述）
        运镜描述 = 运镜描述.split("，")[0] if "，" in 运镜描述 else 运镜描述
        
        return 运镜描述

    def _获取序号前缀(self, 序号):
        """获取镜头序号的中文前缀，如"第1个镜头"或"镜头1："""
        序号映射 = {
            1: "第一个镜头",
            2: "第二个镜头", 
            3: "第三个镜头",
            4: "第四个镜头",
            5: "第五个镜头"
        }
        return 序号映射.get(序号, f"镜头{序号}")

    def _生成镜头结构表(self, 镜头数据, 转场效果, 时间格式):
        """生成镜头结构表，用于技术说明"""
        结构行 = []
        
        结构行.append("镜头结构表：")
        结构行.append("序号 | 时间范围 | 时长 | 内容概要")
        结构行.append("-" * 60)
        
        for 镜头 in 镜头数据:
            if not 镜头["描述"]:
                continue
                
            # 提取描述的前20个字作为概要
            内容概要 = 镜头["描述"][:20] + "..." if len(镜头["描述"]) > 20 else 镜头["描述"]
            
            # 计算时长
            时长 = self._计算镜头时长(镜头["开始"], 镜头["结束"], 时间格式)
            
            结构行.append(f"{镜头['序号']} | {镜头['开始']}-{镜头['结束']} | {时长} | {内容概要}")
        
        if 转场效果 and 转场效果 != "无":
            结构行.append(f"\n转场方式：{转场效果}")
        
        return "\n".join(结构行)

    def _计算镜头时长(self, 开始时间, 结束时间, 时间格式):
        """计算镜头时长"""
        开始 = 开始时间.replace("秒", "").replace("帧", "").strip()
        结束 = 结束时间.replace("秒", "").replace("帧", "").strip()
        
        try:
            开始数 = float(开始)
            结束数 = float(结束)
            
            if 时间格式 == "帧":
                # 帧转秒（假设30fps）
                时长秒 = (结束数 - 开始数) / 30
                return f"{时长秒:.1f}秒"
            else:
                时长秒 = 结束数 - 开始数
                return f"{时长秒:.1f}秒"
        except:
            return "时长未知"

    def _生成完整提示词(self, 多镜头提示词, 总体描述, 附加指令, 视频总时长, 时间格式):
        """生成完整提示词"""
        组件 = []
        
        # 添加视频总时长信息
        if 视频总时长:
            组件.append(f"视频总时长：{视频总时长}{时间格式}")
        
        # 添加多镜头提示词
        if 多镜头提示词:
            组件.append(多镜头提示词)
        
        # 添加总体描述作为补充
        if 总体描述:
            组件.append(f"\n总体描述：{总体描述}")
        
        # 添加附加指令
        if 附加指令:
            组件.append(f"\n附加指令：{附加指令}")
        
        完整提示词 = "\n".join(组件)
        
        # 清理多余的换行
        完整提示词 = re.sub(r'\n\s*\n\s*\n', '\n\n', 完整提示词)
        
        return 完整提示词