# å›¾è½¬è§†é¢‘é¢„è®¾.py
import re
import logging
from å¸¸é‡é…ç½® import *

from å·¥å…·å‡½æ•° import clean_text

# è§†é¢‘é¦–å°¾å¸§è½¬åœºåŸºç±»ï¼ˆæå–å…¬å…±æ–¹æ³•ï¼‰
class è§†é¢‘è½¬åœºåŸºç±»:
    """è½¬åœºèŠ‚ç‚¹çš„åŸºç±»ï¼ŒåŒ…å«å…¬å…±æ–¹æ³•"""
    
    def _extract_subject_with_quotes(self, description):
        """ä»æè¿°ä¸­æå–ä¸»ä½“ï¼Œä¼˜å…ˆä»å¼•å·ä¸­æå–ï¼Œæ”¯æŒä¸­è‹±æ–‡å¼•å·"""
        if not description:
            return None
        
        # å…ˆå°è¯•ä»å¼•å·ä¸­æå–
        # æ”¯æŒä¸­æ–‡å¼•å·ï¼š" " å’Œ ' ' ä»¥åŠè‹±æ–‡å¼•å·: " " å’Œ ' '
        å¼•å·æ¨¡å¼ = [
            r'["]([^"]+)["]',     # è‹±æ–‡åŒå¼•å·
            r"[']([^']+)[']",     # è‹±æ–‡å•å¼•å·
            r'["]([^"]+)["]',     # ä¸­æ–‡åŒå¼•å·ï¼ˆä¸è‹±æ–‡ç›¸åŒï¼‰
            r"[']([^']+)[']",     # ä¸­æ–‡å•å¼•å·ï¼ˆä¸è‹±æ–‡ç›¸åŒï¼‰
        ]
        
        for pattern in å¼•å·æ¨¡å¼:
            matches = re.findall(pattern, description)
            if matches:
                # è¿”å›ç¬¬ä¸€ä¸ªå¼•å·å†…çš„å†…å®¹
                subject = matches[0].strip()
                if subject:
                    return subject
        
        # å¦‚æœæ²¡æœ‰å¼•å·å†…å®¹ï¼Œä½¿ç”¨åŸæ¥çš„æå–æ–¹æ³•
        return self._extract_main_subject(description)

    def _extract_main_subject(self, description):
        """ä»æè¿°ä¸­è‡ªåŠ¨æå–ä¸»è¦ä¸»ä½“ - ä¼˜åŒ–ç‰ˆæœ¬"""
        if not description:
            return "ä¸»ä½“"
        
        # ç§»é™¤æ ‡ç‚¹ç¬¦å·
        cleaned_desc = re.sub(r'[ï¼Œã€‚ï¼ï¼Ÿï¼›,\.!?;]', ' ', description)
        
        # å°è¯•å¤šç§æå–æ¨¡å¼ï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åº
        patterns = [
            # æ¨¡å¼1: é‡è¯ + å½¢å®¹è¯ + åè¯ (å¦‚: "ä¸€æœµå«è‹å¾…æ”¾çš„è·èŠ±")
            r'(?:ä¸€ä¸ª|ä¸€æœµ|ä¸€åª|ä¸€åº§|ä¸€ä»¶|ä¸€å¼ |ä¸€å°)([\u4e00-\u9fa5]{2,10}?(?:çš„)?[\u4e00-\u9fa5]{2,10})',
            # æ¨¡å¼2: ç›´æ¥çš„åè¯çŸ­è¯­ (å¦‚: "ç»½æ”¾çš„è·èŠ±ç‰¹å†™")
            r'([\u4e00-\u9fa5]{2,6}çš„[\u4e00-\u9fa5]{2,10})',
            # æ¨¡å¼3: å½¢å®¹è¯ + åè¯ (å¦‚: "ç¾ä¸½çš„èŠ±æœµ")
            r'([\u4e00-\u9fa5]{2,6}[\u4e00-\u9fa5]{2,8})',
            # æ¨¡å¼4: å•ç‹¬çš„åè¯ (è‡³å°‘2ä¸ªå­—ç¬¦)
            r'([\u4e00-\u9fa5]{2,10})',
        ]
        
        for pattern in patterns:
            matches = re.findall(pattern, cleaned_desc)
            if matches:
                # é€‰æ‹©ç¬¬ä¸€ä¸ªåŒ¹é…ä¸”é•¿åº¦é€‚ä¸­çš„ç»“æœ
                for match in matches:
                    subject = match.strip()
                    if 2 <= len(subject) <= 12:  # é™åˆ¶é•¿åº¦èŒƒå›´
                        # è¿›ä¸€æ­¥æ¸…ç†ï¼Œå»é™¤å¯èƒ½çš„ä¿®é¥°è¯
                        subject = self._refine_subject(subject)
                        if subject:
                            return subject
        
        # å¦‚æœæ‰€æœ‰æ¨¡å¼éƒ½å¤±è´¥ï¼Œè¿”å›æè¿°çš„å‰å‡ ä¸ªè¯
        words = cleaned_desc.split()
        if words:
            # å–å‰2-3ä¸ªè¯ä½œä¸ºä¸»ä½“
            candidate = ' '.join(words[:min(3, len(words))])
            if len(candidate) <= 15:
                return candidate
        
        return "ä¸»ä½“"

    def _extract_character_subject(self, description, existing_subject=None):
        """ä¸“é—¨æå–äººç‰©ä¸»ä½“ - é’ˆå¯¹äººç‰©åˆ°äººç‰©å˜åŒ–ä¼˜åŒ–"""
        if existing_subject and existing_subject != "å›¾åƒ1ä¸»ä½“" and existing_subject != "å›¾åƒ2ä¸»ä½“":
            return existing_subject
            
        if not description:
            return "äººç‰©"
        
        # äººç‰©ç›¸å…³å…³é”®è¯
        character_keywords = ['å¥³å­©', 'ç”·å­©', 'å¥³äºº', 'ç”·äºº', 'å¥³æ€§', 'ç”·æ€§', 'äººç‰©', 'äºº', 'è§’è‰²']
        
        # é¦–å…ˆæ£€æŸ¥æ˜¯å¦åŒ…å«äººç‰©å…³é”®è¯
        for keyword in character_keywords:
            if keyword in description:
                # å°è¯•æå–åŒ…å«å…³é”®è¯çš„çŸ­è¯­
                pattern = rf'([\u4e00-\u9fa5]*{keyword}[\u4e00-\u9fa5]*)'
                matches = re.findall(pattern, description)
                if matches:
                    return matches[0]
        
        # å¦‚æœæ²¡æœ‰æ˜ç¡®çš„äººç‰©å…³é”®è¯ï¼Œä½¿ç”¨é€šç”¨æå–
        return self._extract_main_subject(description) or "äººç‰©"

    def _refine_subject(self, subject):
        """è¿›ä¸€æ­¥ç²¾ç‚¼æå–çš„ä¸»ä½“"""
        # å»é™¤å¸¸è§çš„ä¿®é¥°å‰ç¼€
        modifiers = ['ç¾ä¸½çš„', 'æ¼‚äº®çš„', 'å¯çˆ±çš„', 'å¤§å¤§çš„', 'å°å°çš„', 'ä¸€æœµ', 'ä¸€ä¸ª', 'ä¸€åª']
        for modifier in modifiers:
            if subject.startswith(modifier):
                subject = subject[len(modifier):]
                break
        
        # å»é™¤å¸¸è§çš„ä¿®é¥°åç¼€
        modifiers_suffix = ['ç‰¹å†™', 'é•œå¤´', 'ç”»é¢', 'å›¾åƒ', 'ç…§ç‰‡']
        for modifier in modifiers_suffix:
            if subject.endswith(modifier):
                subject = subject[:-len(modifier)]
                break
        
        return subject.strip()

    def _extract_quoted_text_only(self, description):
        """ä»…ä»æè¿°ä¸­æå–å¼•å·å†…çš„å†…å®¹ï¼Œå¦‚æœæ²¡æœ‰å¼•å·åˆ™è¿”å›None"""
        if not description:
            return None
        
        # æ”¯æŒä¸­è‹±æ–‡å¼•å·
        å¼•å·æ¨¡å¼ = [
            r'["]([^"]+)["]',     # è‹±æ–‡åŒå¼•å·
            r"[']([^']+)[']",     # è‹±æ–‡å•å¼•å·
            r'["]([^"]+)["]',     # ä¸­æ–‡åŒå¼•å·
            r"[']([^']+)[']",     # ä¸­æ–‡å•å¼•å·
        ]
        
        for pattern in å¼•å·æ¨¡å¼:
            matches = re.findall(pattern, description)
            if matches:
                # è¿”å›ç¬¬ä¸€ä¸ªå¼•å·å†…çš„å†…å®¹
                subject = matches[0].strip()
                if subject:
                    return subject
        
        return None

    def _get_default_occlusion_name(self, é®æŒ¡ç±»å‹):
        """è·å–ä¸åŒé®æŒ¡ç‰©ç±»å‹çš„é»˜è®¤åç§° - ä½¿ç”¨å¸¸é‡é…ç½®"""
        return OCCLUSION_DEFAULT_NAMES.get(é®æŒ¡ç±»å‹, "ç‰©ä½“")
    
    def _replace_occlusion_name_with_subject(self, é®æŒ¡æè¿°, é®æŒ¡ç‰©åç§°):
        """ç”¨å…·ä½“çš„ä¸»ä½“åç§°æ›¿æ¢é®æŒ¡æè¿°ä¸­çš„é€šç”¨è¯æ±‡ - ä½¿ç”¨å¸¸é‡é…ç½®"""
        # ä½¿ç”¨å¸¸é‡é…ç½®ä¸­çš„é€šç”¨è¯æ±‡åˆ—è¡¨
        ä¿®æ”¹åçš„æè¿° = é®æŒ¡æè¿°
        for é€šç”¨è¯ in OCCLUSION_GENERIC_WORDS:
            if é€šç”¨è¯ in ä¿®æ”¹åçš„æè¿°:
                ä¿®æ”¹åçš„æè¿° = ä¿®æ”¹åçš„æè¿°.replace(é€šç”¨è¯, é®æŒ¡ç‰©åç§°)
                break  # åªæ›¿æ¢ç¬¬ä¸€ä¸ªåŒ¹é…çš„é€šç”¨è¯æ±‡
        
        return ä¿®æ”¹åçš„æè¿°
    
    def _get_motion_description(self, è¿åŠ¨å­ç±»å‹, è¿åŠ¨æ–¹å‘):
        """æ ¹æ®è¿åŠ¨å­ç±»å‹å’Œæ–¹å‘ç”Ÿæˆé•œå¤´è¿åŠ¨æè¿° - ä½¿ç”¨å¸¸é‡é…ç½®"""
        # ä»å¸¸é‡é…ç½®ä¸­è·å–æè¿°æ˜ å°„
        å­ç±»å‹æè¿° = MOTION_SUBTYPE_DESCRIPTIONS.get(è¿åŠ¨å­ç±»å‹, è¿åŠ¨å­ç±»å‹.replace("è½¬åœº", ""))
        æ–¹å‘æè¿° = MOTION_DIRECTION_DESCRIPTIONS.get(è¿åŠ¨æ–¹å‘, è¿åŠ¨æ–¹å‘)
        
        # ç»„åˆæˆé•œå¤´è¿åŠ¨æè¿°
        if è¿åŠ¨å­ç±»å‹ == "æ—‹è½¬è½¬åœº":
            return f"{æ–¹å‘æè¿°}{å­ç±»å‹æè¿°}"
        else:
            return f"{æ–¹å‘æè¿°}{å­ç±»å‹æè¿°}"

    def _generate_motion_transition(self, å­ç±»å‹, æ–¹å‘, æ—¶é•¿, å¹³æ»‘åº¦, èŠ‚å¥):
        """ç”Ÿæˆè¿åŠ¨è½¬åœºæç¤ºè¯ - ä½¿ç”¨å¸¸é‡é…ç½®"""
        if not å­ç±»å‹ or å­ç±»å‹ == "æ— ":
            return f"é•œå¤´è¿åŠ¨è½¬åœºï¼Œå†æ—¶{æ—¶é•¿}ç§’ï¼Œ{å¹³æ»‘åº¦}ï¼Œ{èŠ‚å¥}"
            
        æ–¹å‘æè¿° = f"å‘{æ–¹å‘}" if æ–¹å‘ and æ–¹å‘ != "æ— " else ""
        
        # ä»å¸¸é‡é…ç½®ä¸­è·å–è¿åŠ¨è½¬åœºæè¿°æ¨¡æ¿
        æè¿°æ¨¡æ¿ = MOTION_TRANSITION_DESCRIPTIONS.get(å­ç±»å‹, f"é•œå¤´è¿åŠ¨è½¬åœºï¼Œå†æ—¶{æ—¶é•¿}ç§’ï¼Œ{å¹³æ»‘åº¦}ï¼Œ{èŠ‚å¥}")
        return æè¿°æ¨¡æ¿.replace("{æ–¹å‘}", æ–¹å‘æè¿°).replace("{æ—¶é•¿}", æ—¶é•¿).replace("{å¹³æ»‘åº¦}", å¹³æ»‘åº¦).replace("{èŠ‚å¥}", èŠ‚å¥)

    def _generate_morph_transition(self, å­ç±»å‹, æ—¶é•¿, å¹³æ»‘åº¦):
        """ç”Ÿæˆå½¢æ€å˜å½¢è½¬åœºæç¤ºè¯ - ä½¿ç”¨å¸¸é‡é…ç½®"""
        if not å­ç±»å‹ or å­ç±»å‹ == "æ— ":
            return f"å½¢æ€å˜å½¢è½¬åœºï¼Œå†æ—¶{æ—¶é•¿}ç§’ï¼Œå˜å½¢è¿‡ç¨‹{å¹³æ»‘åº¦}"
        
        # ä»å¸¸é‡é…ç½®ä¸­è·å–å½¢æ€å˜å½¢æè¿°æ¨¡æ¿
        æè¿°æ¨¡æ¿ = MORPH_TRANSITION_DESCRIPTIONS.get(å­ç±»å‹, f"å½¢æ€å˜å½¢è½¬åœºï¼Œå†æ—¶{æ—¶é•¿}ç§’ï¼Œ{å¹³æ»‘åº¦}")
        return æè¿°æ¨¡æ¿.replace("{æ—¶é•¿}", æ—¶é•¿).replace("{å¹³æ»‘åº¦}", å¹³æ»‘åº¦)

    def _get_visual_consistency_description(self, è¿è´¯æ€§):
        """è·å–è§†è§‰è¿è´¯æ€§æè¿° - ä½¿ç”¨å¸¸é‡é…ç½®"""
        return VISUAL_CONSISTENCY_DESCRIPTIONS.get(è¿è´¯æ€§, "ä¿æŒè§†è§‰è¿è´¯æ€§")

    def _get_speed_description(self, é€Ÿåº¦):
        """è·å–é€Ÿåº¦æè¿°"""
        é€Ÿåº¦æè¿°æ˜ å°„ = {
            "ææ…¢é€Ÿ": "æå…¶ç¼“æ…¢å¹³ç¨³",
            "æ…¢é€Ÿ": "ç¼“æ…¢å¹³ç¨³", 
            "ä¸­é€Ÿ": "é€Ÿåº¦é€‚ä¸­",
            "å¿«é€Ÿ": "å¿«é€Ÿæµç•…",
            "æå¿«é€Ÿ": "æé€Ÿè¿…çŒ›"
        }
        return é€Ÿåº¦æè¿°æ˜ å°„.get(é€Ÿåº¦, "é€Ÿåº¦é€‚ä¸­")

    def _get_intensity_description(self, å¼ºåº¦):
        """è·å–å¼ºåº¦æè¿° - ä½¿ç”¨å¸¸é‡é…ç½®"""
        return EFFECT_INTENSITY_DESCRIPTIONS.get(å¼ºåº¦, "æ•ˆæœé€‚ä¸­")

    def _get_duration_description(self, æ—¶é•¿):
        """è·å–æ—¶é•¿æè¿° - ä½¿ç”¨å¸¸é‡é…ç½®"""
        return EFFECT_DURATION_DESCRIPTIONS.get(æ—¶é•¿, "æŒç»­æ—¶é—´é€‚ä¸­")

    def _generate_full_prompt(self, é¦–å¸§, å°¾å¸§, è½¬åœº, é™„åŠ æè¿°):
        """ç”Ÿæˆå®Œæ•´æç¤ºè¯"""
        ç»„ä»¶ = []
        
        if é¦–å¸§:
            ç»„ä»¶.append(é¦–å¸§)
        
        # å¤„ç†è½¬åœºæç¤ºè¯
        if è½¬åœº:
            ç»„ä»¶.append(è½¬åœº)
        
        if å°¾å¸§:
            ç»„ä»¶.append(å°¾å¸§)
        
        if é™„åŠ æè¿°:
            ç»„ä»¶.append(é™„åŠ æè¿°)
        
        # å¦‚æœæ‰€æœ‰ç»„ä»¶éƒ½ä¸ºç©ºï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²
        if not ç»„ä»¶:
            return ""
        
        å®Œæ•´æç¤ºè¯ = "ï¼Œ".join(ç»„ä»¶)
        
        # æœ€ç»ˆæ¸…ç†
        å®Œæ•´æç¤ºè¯ = re.sub(r',\s+,', ',', å®Œæ•´æç¤ºè¯)
        å®Œæ•´æç¤ºè¯ = re.sub(r'\s+', ' ', å®Œæ•´æç¤ºè¯).strip()
        
        return å®Œæ•´æç¤ºè¯

    def _generate_full_prompt_with_effects(self, é¦–å¸§, å°¾å¸§, è½¬åœº, äººç‰©æ•ˆæœ="", ç¯å¢ƒæ•ˆæœ="", é™„åŠ æè¿°=""):
        """ç”Ÿæˆå®Œæ•´æç¤ºè¯ï¼ˆå¸¦åŠ¨æ€æ•ˆæœï¼‰"""
        ç»„ä»¶ = []
        
        if é¦–å¸§:
            ç»„ä»¶.append(é¦–å¸§)
        
        # å¤„ç†è½¬åœºæç¤ºè¯
        if è½¬åœº:
            ç»„ä»¶.append(è½¬åœº)
        
        # å¤„ç†äººç‰©åŠ¨æ€æ•ˆæœï¼ˆä½œä¸ºè½¬åœºçš„è¡¥å……ï¼‰
        if äººç‰©æ•ˆæœ:
            ç»„ä»¶.append(äººç‰©æ•ˆæœ)
        
        # å¤„ç†ç¯å¢ƒåŠ¨æ€æ•ˆæœï¼ˆä½œä¸ºè½¬åœºçš„è¡¥å……ï¼‰
        if ç¯å¢ƒæ•ˆæœ:
            ç»„ä»¶.append(ç¯å¢ƒæ•ˆæœ)
        
        if å°¾å¸§:
            ç»„ä»¶.append(å°¾å¸§)
        
        if é™„åŠ æè¿°:
            ç»„ä»¶.append(é™„åŠ æè¿°)
        
        # å¦‚æœæ‰€æœ‰ç»„ä»¶éƒ½ä¸ºç©ºï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²
        if not ç»„ä»¶:
            return ""
        
        å®Œæ•´æç¤ºè¯ = "ï¼Œ".join(ç»„ä»¶)
        
        # æœ€ç»ˆæ¸…ç†
        å®Œæ•´æç¤ºè¯ = re.sub(r',\s+,', ',', å®Œæ•´æç¤ºè¯)
        å®Œæ•´æç¤ºè¯ = re.sub(r'\s+', ' ', å®Œæ•´æç¤ºè¯).strip()
        
        return å®Œæ•´æç¤ºè¯

    def _generate_full_prompt_with_visual_consistency(self, é¦–å¸§, å°¾å¸§, è½¬åœº, è§†è§‰è¿è´¯æ€§, é™„åŠ æè¿°=""):
        """ç”Ÿæˆå®Œæ•´æç¤ºè¯ï¼ˆå°†å°¾å¸§æè¿°æ”¾åœ¨è§†è§‰è¿è´¯æ€§æè¿°çš„åé¢ï¼‰"""
        ç»„ä»¶ = []
        
        # 1. æ·»åŠ é¦–å¸§æè¿°
        if é¦–å¸§:
            ç»„ä»¶.append(é¦–å¸§)
        
        # 2. å¤„ç†è½¬åœºã€è§†è§‰è¿è´¯æ€§ã€å°¾å¸§æè¿°
        è½¬åœºç»„ä»¶ = []
        if è½¬åœº:
            è½¬åœºç»„ä»¶.append(è½¬åœº)
        
            # æ·»åŠ è§†è§‰è¿è´¯æ€§æè¿°ï¼ˆå¦‚æœæœ‰è½¬åœºä¸”æœ‰è§†è§‰è¿è´¯æ€§ï¼‰
            if è§†è§‰è¿è´¯æ€§ and è§†è§‰è¿è´¯æ€§ != "æ— ":
                è¿è´¯æ€§æè¿° = self._get_visual_consistency_description(è§†è§‰è¿è´¯æ€§)
                è½¬åœºç»„ä»¶.append(è¿è´¯æ€§æè¿°)
        
        # æ·»åŠ å°¾å¸§æè¿°ï¼ˆå¦‚æœæœ‰è½¬åœºç»„ä»¶æˆ–ç›´æ¥æ·»åŠ ï¼‰
        if å°¾å¸§:
            if è½¬åœºç»„ä»¶:
                # å°†å°¾å¸§æè¿°æ·»åŠ åˆ°è½¬åœºç»„ä»¶ä¸­
                è½¬åœºç»„ä»¶.append(å°¾å¸§)
                ç»„ä»¶.append("ï¼Œ".join(è½¬åœºç»„ä»¶))
            else:
                # æ²¡æœ‰è½¬åœºï¼Œç›´æ¥æ·»åŠ å°¾å¸§
                ç»„ä»¶.append(å°¾å¸§)
        elif è½¬åœºç»„ä»¶:
            # åªæœ‰è½¬åœºæ²¡æœ‰å°¾å¸§
            ç»„ä»¶.append("ï¼Œ".join(è½¬åœºç»„ä»¶))
        
        # 3. æ·»åŠ é™„åŠ æè¿°
        if é™„åŠ æè¿°:
            ç»„ä»¶.append(é™„åŠ æè¿°)
        
        # å¦‚æœæ‰€æœ‰ç»„ä»¶éƒ½ä¸ºç©ºï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²
        if not ç»„ä»¶:
            return ""
        
        å®Œæ•´æç¤ºè¯ = "ï¼Œ".join(ç»„ä»¶)
        
        # æœ€ç»ˆæ¸…ç†
        å®Œæ•´æç¤ºè¯ = re.sub(r',\s+,', ',', å®Œæ•´æç¤ºè¯)
        å®Œæ•´æç¤ºè¯ = re.sub(r'\s+', ' ', å®Œæ•´æç¤ºè¯).strip()
        
        return å®Œæ•´æç¤ºè¯

    def _generate_occlusion_transition(self, é®æŒ¡ç±»å‹, æ—¶é•¿, èŠ‚å¥, è¿åŠ¨å­ç±»å‹="æ— ", è¿åŠ¨æ–¹å‘="æ— ", å‰æ™¯é®æŒ¡ç‰©=None):
        """ç”Ÿæˆé®æŒ¡ç‰©è½¬åœºæç¤ºè¯ - ä¿®æ”¹ç‰ˆï¼šä½¿ç”¨å‰æ™¯é®æŒ¡ç‰©ç»„ä»¶è¾“å…¥"""
        if not é®æŒ¡ç±»å‹ or é®æŒ¡ç±»å‹ == "æ— ":
            return f"é®æŒ¡ç‰©è½¬åœºï¼Œå†æ—¶{æ—¶é•¿}ç§’ï¼Œ{èŠ‚å¥}"
        
        # å®‰å…¨è·å–é®æŒ¡æè¿°
        é®æŒ¡æè¿° = OCCLUSION_DESCRIPTIONS.get(é®æŒ¡ç±»å‹, f"é®æŒ¡ç‰©è½¬åœºï¼Œå†æ—¶{æ—¶é•¿}ç§’ï¼Œ{èŠ‚å¥}")
        
        # è·å–é®æŒ¡ç‰©åç§°
        é®æŒ¡ç‰©åç§° = None
        
        if é®æŒ¡ç±»å‹ == "å‰æ™¯ç‰©ä½“é®æŒ¡":
            # ä¼˜å…ˆä½¿ç”¨å‰æ™¯é®æŒ¡ç‰©ç»„ä»¶è¾“å…¥
            if å‰æ™¯é®æŒ¡ç‰©:
                é®æŒ¡ç‰©åç§° = clean_text(å‰æ™¯é®æŒ¡ç‰©)
            
            # å¦‚æœæ²¡æœ‰æä¾›å‰æ™¯é®æŒ¡ç‰©ï¼Œåˆ™ä½¿ç”¨é»˜è®¤çš„é®æŒ¡ç‰©åç§°
            if not é®æŒ¡ç‰©åç§°:
                é®æŒ¡ç‰©åç§° = self._get_default_occlusion_name(é®æŒ¡ç±»å‹)
        else:
            # å¯¹äºå…¶ä»–é®æŒ¡ç±»å‹ï¼Œä½¿ç”¨å¸¸é‡é…ç½®è·å–é»˜è®¤çš„é®æŒ¡ç‰©åç§°
            é®æŒ¡ç‰©åç§° = self._get_default_occlusion_name(é®æŒ¡ç±»å‹)
        
        # å¦‚æœè¿åŠ¨å­ç±»å‹å’Œè¿åŠ¨æ–¹å‘ä¸ä¸º"æ— "ï¼Œåˆ™ç”ŸæˆåŒ…å«é•œå¤´è¿åŠ¨çš„æè¿°
        if è¿åŠ¨å­ç±»å‹ != "æ— " and è¿åŠ¨æ–¹å‘ != "æ— ":
            # æ ¹æ®è¿åŠ¨å­ç±»å‹ç”Ÿæˆç›¸åº”çš„é•œå¤´è¿åŠ¨æè¿°
            è¿åŠ¨æè¿° = self._get_motion_description(è¿åŠ¨å­ç±»å‹, è¿åŠ¨æ–¹å‘)
            
            # ä¿®æ”¹æè¿°æ¨¡æ¿ä»¥åŒ…å«é•œå¤´è¿åŠ¨ï¼Œå¹¶æ›¿æ¢é®æŒ¡ç‰©åç§°
            æè¿°éƒ¨åˆ† = self._replace_occlusion_name_with_subject(é®æŒ¡æè¿°, é®æŒ¡ç‰©åç§°)
            
            # æ›¿æ¢å ä½ç¬¦
            æè¿°éƒ¨åˆ† = æè¿°éƒ¨åˆ†.replace("{target}", é®æŒ¡ç‰©åç§°)
            æè¿°éƒ¨åˆ† = æè¿°éƒ¨åˆ†.replace("{æ—¶é•¿}", str(æ—¶é•¿))
            æè¿°éƒ¨åˆ† = æè¿°éƒ¨åˆ†.replace("{èŠ‚å¥}", èŠ‚å¥)
            
            # æ·»åŠ é•œå¤´è¿åŠ¨æè¿°åˆ°å‰é¢
            å®Œæ•´æè¿° = f"é•œå¤´{è¿åŠ¨æè¿°}ï¼Œ{æè¿°éƒ¨åˆ†}"
            
            return å®Œæ•´æè¿°
        else:
            # ä¸ä½¿ç”¨é•œå¤´è¿åŠ¨ï¼Œç›´æ¥æ›¿æ¢æè¿°ä¸­çš„é®æŒ¡ç‰©åç§°
            æè¿°éƒ¨åˆ† = self._replace_occlusion_name_with_subject(é®æŒ¡æè¿°, é®æŒ¡ç‰©åç§°)
            
            # æ›¿æ¢å ä½ç¬¦
            æè¿°éƒ¨åˆ† = æè¿°éƒ¨åˆ†.replace("{target}", é®æŒ¡ç‰©åç§°)
            æè¿°éƒ¨åˆ† = æè¿°éƒ¨åˆ†.replace("{æ—¶é•¿}", str(æ—¶é•¿))
            æè¿°éƒ¨åˆ† = æè¿°éƒ¨åˆ†.replace("{èŠ‚å¥}", èŠ‚å¥)
            
            return æè¿°éƒ¨åˆ†

    def _generate_unfold_transition(self, å±•å¼€æ–¹å¼, æ—¶é•¿, èŠ‚å¥, å‰æ™¯é®æŒ¡ç‰©=None, é»˜è®¤ä¸»ä½“="ä¸»ä½“"):
        """ç”Ÿæˆç”»å·å±•å¼€å¼è½¬åœºæç¤ºè¯"""
        # è·å–å±•å¼€çš„ç›®æ ‡
        å±•å¼€ç›®æ ‡ = å‰æ™¯é®æŒ¡ç‰© if å‰æ™¯é®æŒ¡ç‰© else é»˜è®¤ä¸»ä½“
        
        # æ ¹æ®å±•å¼€æ–¹å¼ç”Ÿæˆå¯¹åº”çš„æè¿°
        å±•å¼€æè¿°æ˜ å°„ = {
            "äººç‰©å±•å¼€": f"{å±•å¼€ç›®æ ‡}èµ°åˆ°é•œå¤´å‰å‘ä¸¤è¾¹åˆ†æ•£å¼€ï¼Œç”»é¢ä¹Ÿä»ä¸­é—´å‘ä¸¤è¾¹å±•å¼€è¿‡æ¸¡åˆ°ä¸‹ä¸€ä¸ªç”»é¢",
            "ç‰©ä½“å±•å¼€": f"{å±•å¼€ç›®æ ‡}åœ¨é•œå¤´å‰å‘ä¸¤è¾¹å±•å¼€ï¼Œç”»é¢ä¹Ÿéšä¹‹ä»ä¸­é—´å‘ä¸¤è¾¹å±•å¼€è¿‡æ¸¡åˆ°ä¸‹ä¸€ä¸ªç”»é¢",
            "ç”»å·å±•å¼€": f"{å±•å¼€ç›®æ ‡}åƒç”»å·ä¸€æ ·åœ¨é•œå¤´å‰å‘ä¸¤è¾¹å±•å¼€ï¼Œç”»é¢ä¹Ÿä»ä¸­é—´å‘ä¸¤è¾¹å±•å¼€è¿‡æ¸¡åˆ°ä¸‹ä¸€ä¸ªç”»é¢",
            "é—¨çª—å±•å¼€": f"{å±•å¼€ç›®æ ‡}åƒé—¨çª—ä¸€æ ·å‘ä¸¤è¾¹æ‰“å¼€ï¼Œç”»é¢ä¹Ÿéšä¹‹å±•å¼€è¿‡æ¸¡åˆ°ä¸‹ä¸€ä¸ªç”»é¢",
            "å¯¹ç§°å±•å¼€": f"{å±•å¼€ç›®æ ‡}ä»¥ç”»é¢ä¸­å¿ƒä¸ºè½´å¿ƒå‘ä¸¤è¾¹å¯¹ç§°å±•å¼€ï¼Œç”»é¢ä¹Ÿä»ä¸­é—´å‘ä¸¤è¾¹å±•å¼€è¿‡æ¸¡",
        }
        
        å±•å¼€æè¿° = å±•å¼€æè¿°æ˜ å°„.get(å±•å¼€æ–¹å¼, f"{å±•å¼€ç›®æ ‡}åœ¨é•œå¤´å‰å‘ä¸¤è¾¹å±•å¼€ï¼Œç”»é¢ä¹Ÿä»ä¸­é—´å‘ä¸¤è¾¹å±•å¼€è¿‡æ¸¡åˆ°ä¸‹ä¸€ä¸ªç”»é¢")
        
        return f"{å±•å¼€æè¿°}ï¼Œå†æ—¶{æ—¶é•¿}ç§’ï¼Œ{èŠ‚å¥}"


class è§†é¢‘é¦–å°¾å¸§è½¬åœº(è§†é¢‘è½¬åœºåŸºç±»):
    @classmethod
    def INPUT_TYPES(cls):
        return {
            "required": {
                "é¦–å¸§æè¿°_å»ºè®®å¡«å†™": ("STRING", {
                    "multiline": False,
                    "default": "",
                    "display_name": "é¦–å¸§æè¿°_å»ºè®®å¡«å†™"
                }),
                "å°¾å¸§æè¿°_å»ºè®®å¡«å†™": ("STRING", {
                    "multiline": False,
                    "default": "",
                    "display_name": "å°¾å¸§æè¿°_å»ºè®®å¡«å†™"
                }),
                "ä¸»è¦è½¬åœºæ–¹å¼": (TRANSITION_TYPES, {
                    "default": "è¿é•œæç¤ºè¯è½¬åœº",
                    "display_name": "ä¸»è¦è½¬åœºæ–¹å¼"
                }),
                "è½¬åœºæ—¶é•¿": ("FLOAT", {
                    "default": 3.0,
                    "min": 1.0,
                    "max": 10.0,
                    "step": 0.1,
                    "display": "slider",
                    "display_name": "è½¬åœºæ—¶é•¿(ç§’)"
                }),
                "è¿åŠ¨å¹³æ»‘åº¦": (TRANSITION_SMOOTHNESS, {
                    "default": "å¹³æ»‘",
                    "display_name": "è¿åŠ¨å¹³æ»‘åº¦"
                }),
            },
            "optional": {
                # è¿åŠ¨è½¬åœºä¸“ç”¨å‚æ•°
                "è¿åŠ¨å­ç±»å‹": (MOTION_TRANSITION_SUBTYPES, {
                    "default": "ç¼©æ”¾è½¬åœº",
                    "display_name": "è¿åŠ¨å­ç±»å‹"
                }),
                "è¿åŠ¨æ–¹å‘": (MOTION_DIRECTIONS, {
                    "default": "å‘å‰",
                    "display_name": "è¿åŠ¨æ–¹å‘"
                }),
                
                # å˜å½¢è½¬åœºä¸“ç”¨å‚æ•°
                "å˜å½¢å­ç±»å‹": (MORPH_TRANSITION_SUBTYPES, {
                    "default": "æœ‰æœºå˜å½¢",
                    "display_name": "å˜å½¢å­ç±»å‹"
                }),
                
                # é®æŒ¡ç‰©è½¬åœºä¸“ç”¨å‚æ•°
                "é®æŒ¡ç‰©ç±»å‹": (OCCLUSION_TYPES, {
                    "default": "å‰æ™¯ç‰©ä½“é®æŒ¡",
                    "display_name": "é®æŒ¡ç‰©ç±»å‹"
                }),
                # æ–°å¢ï¼šå‰æ™¯é®æŒ¡ç‰©ç»„ä»¶
                "å‰æ™¯é®æŒ¡ç‰©": ("STRING", {
                    "multiline": False,
                    "default": "",
                    "display_name": "å‰æ™¯é®æŒ¡ç‰©"
                }),
                
                # ç”»å·å±•å¼€å¼è½¬åœºä¸“ç”¨å‚æ•°
                "å±•å¼€æ–¹å¼": ([
                    "äººç‰©å±•å¼€", "ç‰©ä½“å±•å¼€", "ç”»å·å±•å¼€", "é—¨çª—å±•å¼€", "å¯¹ç§°å±•å¼€"
                ], {
                    "default": "ç”»å·å±•å¼€",
                    "display_name": "å±•å¼€æ–¹å¼"
                }),
                
                # äººç‰©å˜åŒ–ä¸“ç”¨å‚æ•°
                "äººç‰©å˜åŒ–ç±»å‹": (CHARACTER_CHANGE_TYPES, {
                    "default": "å½¢æ€å˜å½¢",
                    "display_name": "äººç‰©å˜åŒ–ç±»å‹"
                }),
                
                # é€šç”¨å¯é€‰å‚æ•°
                "è½¬åœºèŠ‚å¥": (TRANSITION_RHYTHMS, {
                    "default": "ç¼“å…¥ç¼“å‡º",
                    "display_name": "è½¬åœºèŠ‚å¥"
                }),
                "è§†è§‰è¿è´¯æ€§": (VISUAL_CONSISTENCY, {
                    "default": "é£æ ¼ç»Ÿä¸€",
                    "display_name": "è§†è§‰è¿è´¯æ€§"
                }),
                "é™„åŠ è½¬åœºæè¿°": ("STRING", {
                    "multiline": True,
                    "default": "åŠ¨ä½œæµç•…",
                    "display_name": "é™„åŠ è½¬åœºæè¿°"
                }),
            }
        }
    
    RETURN_TYPES = ("STRING", "STRING", "STRING")
    RETURN_NAMES = ("è½¬åœºæç¤ºè¯", "å®Œæ•´æç¤ºè¯", "æŠ€æœ¯è¯´æ˜")
    FUNCTION = "ç”Ÿæˆè½¬åœºæç¤ºè¯"
    CATEGORY = "ğŸ“•æç¤ºè¯å…¬å¼/å›¾è½¬è§†é¢‘"

    def ç”Ÿæˆè½¬åœºæç¤ºè¯(self, é¦–å¸§æè¿°_å»ºè®®å¡«å†™, å°¾å¸§æè¿°_å»ºè®®å¡«å†™, ä¸»è¦è½¬åœºæ–¹å¼, è½¬åœºæ—¶é•¿, è¿åŠ¨å¹³æ»‘åº¦,
                    è¿åŠ¨å­ç±»å‹="ç¼©æ”¾è½¬åœº", è¿åŠ¨æ–¹å‘="å‘å‰", å˜å½¢å­ç±»å‹="æœ‰æœºå˜å½¢",
                    é®æŒ¡ç‰©ç±»å‹="å‰æ™¯ç‰©ä½“é®æŒ¡", å‰æ™¯é®æŒ¡ç‰©="", å±•å¼€æ–¹å¼="ç”»å·å±•å¼€",
                    äººç‰©å˜åŒ–ç±»å‹="å½¢æ€å˜å½¢",
                    è½¬åœºèŠ‚å¥="ç¼“å…¥ç¼“å‡º", è§†è§‰è¿è´¯æ€§="é£æ ¼ç»Ÿä¸€", é™„åŠ è½¬åœºæè¿°=""):
        
        try:
            # æ¸…ç†è¾“å…¥æ–‡æœ¬
            é¦–å¸§æè¿°_å»ºè®®å¡«å†™_æ¸…ç† = clean_text(é¦–å¸§æè¿°_å»ºè®®å¡«å†™)
            å°¾å¸§æè¿°_å»ºè®®å¡«å†™_æ¸…ç† = clean_text(å°¾å¸§æè¿°_å»ºè®®å¡«å†™)
            é™„åŠ æè¿°_æ¸…ç† = clean_text(é™„åŠ è½¬åœºæè¿°)
            å‰æ™¯é®æŒ¡ç‰©_æ¸…ç† = clean_text(å‰æ™¯é®æŒ¡ç‰©)
            
            # è‡ªåŠ¨æå–ä¸»ä½“ï¼ˆä¼˜å…ˆä»å¼•å·ä¸­æå–ï¼‰
            é¦–å¸§ä¸»ä½“_æ¸…ç† = self._extract_subject_with_quotes(é¦–å¸§æè¿°_å»ºè®®å¡«å†™_æ¸…ç†)
            å°¾å¸§ä¸»ä½“_æ¸…ç† = self._extract_subject_with_quotes(å°¾å¸§æè¿°_å»ºè®®å¡«å†™_æ¸…ç†)
            
            # å¯¹äºäººç‰©åˆ°äººç‰©å˜åŒ–ï¼Œç‰¹åˆ«ä¼˜åŒ–ä¸»ä½“æå–
            if ä¸»è¦è½¬åœºæ–¹å¼ == "äººç‰©åˆ°äººç‰©å˜åŒ–":
                é¦–å¸§ä¸»ä½“_æ¸…ç† = self._extract_character_subject(é¦–å¸§æè¿°_å»ºè®®å¡«å†™_æ¸…ç†, é¦–å¸§ä¸»ä½“_æ¸…ç†)
                å°¾å¸§ä¸»ä½“_æ¸…ç† = self._extract_character_subject(å°¾å¸§æè¿°_å»ºè®®å¡«å†™_æ¸…ç†, å°¾å¸§ä¸»ä½“_æ¸…ç†)
            
            # ç¡®ä¿ä¸»ä½“ä¸ä¸ºç©º
            é¦–å¸§ä¸»ä½“_æ¸…ç† = é¦–å¸§ä¸»ä½“_æ¸…ç† or "å›¾åƒ1ä¸»ä½“"
            å°¾å¸§ä¸»ä½“_æ¸…ç† = å°¾å¸§ä¸»ä½“_æ¸…ç† or "å›¾åƒ2ä¸»ä½“"
            
            # æ ¹æ®è½¬åœºæ–¹å¼ç”Ÿæˆå¯¹åº”çš„æç¤ºè¯
            è½¬åœºæç¤ºè¯ = self._generate_transition_prompt(
                ä¸»è¦è½¬åœºæ–¹å¼, è¿åŠ¨å­ç±»å‹, è¿åŠ¨æ–¹å‘, å˜å½¢å­ç±»å‹, é®æŒ¡ç‰©ç±»å‹,
                äººç‰©å˜åŒ–ç±»å‹, è½¬åœºæ—¶é•¿, è¿åŠ¨å¹³æ»‘åº¦, è½¬åœºèŠ‚å¥, è§†è§‰è¿è´¯æ€§,
                é¦–å¸§ä¸»ä½“_æ¸…ç†, å°¾å¸§ä¸»ä½“_æ¸…ç†, å‰æ™¯é®æŒ¡ç‰©_æ¸…ç†, å±•å¼€æ–¹å¼
            )
            
            # ç”Ÿæˆå®Œæ•´æç¤ºè¯ - ä¿®æ”¹ï¼šå°†å°¾å¸§æè¿°æ”¾åœ¨è§†è§‰è¿è´¯æ€§æè¿°çš„åé¢
            å®Œæ•´æç¤ºè¯ = self._generate_full_prompt_with_visual_consistency(
                é¦–å¸§æè¿°_å»ºè®®å¡«å†™_æ¸…ç†, å°¾å¸§æè¿°_å»ºè®®å¡«å†™_æ¸…ç†, è½¬åœºæç¤ºè¯, è§†è§‰è¿è´¯æ€§, é™„åŠ æè¿°_æ¸…ç†
            )
            
            # ç”ŸæˆæŠ€æœ¯è¯´æ˜
            æŠ€æœ¯è¯´æ˜ = self._generate_technical_note(
                ä¸»è¦è½¬åœºæ–¹å¼, è½¬åœºæ—¶é•¿, è¿åŠ¨å¹³æ»‘åº¦, è½¬åœºèŠ‚å¥, è§†è§‰è¿è´¯æ€§,
                é¦–å¸§ä¸»ä½“_æ¸…ç†, å°¾å¸§ä¸»ä½“_æ¸…ç†, äººç‰©å˜åŒ–ç±»å‹, å‰æ™¯é®æŒ¡ç‰©_æ¸…ç†, å±•å¼€æ–¹å¼
            )
            
            return (è½¬åœºæç¤ºè¯, å®Œæ•´æç¤ºè¯, æŠ€æœ¯è¯´æ˜)
            
        except Exception as e:
            logging.error(f"è§†é¢‘é¦–å°¾å¸§è½¬åœºç”Ÿæˆé”™è¯¯: {str(e)}")
            error_msg = f"ç”Ÿæˆè½¬åœºæç¤ºè¯æ—¶å‡ºé”™: {str(e)}"
            return (error_msg, error_msg, error_msg)

    def _generate_transition_prompt(self, ä¸»è¦æ–¹å¼, è¿åŠ¨å­ç±»å‹, è¿åŠ¨æ–¹å‘, å˜å½¢å­ç±»å‹, 
                                  é®æŒ¡ç‰©ç±»å‹, äººç‰©å˜åŒ–ç±»å‹, æ—¶é•¿, å¹³æ»‘åº¦, èŠ‚å¥, è¿è´¯æ€§,
                                  é¦–å¸§ä¸»ä½“, å°¾å¸§ä¸»ä½“, å‰æ™¯é®æŒ¡ç‰©=None, å±•å¼€æ–¹å¼="ç”»å·å±•å¼€"):
        """ç”Ÿæˆå…·ä½“çš„è½¬åœºæç¤ºè¯"""
        
        # å¦‚æœä¸»è¦è½¬åœºæ–¹å¼ä¸º"æ— "ï¼Œç›´æ¥è¿”å›ç©ºå­—ç¬¦ä¸²
        if ä¸»è¦æ–¹å¼ == "æ— ":
            return ""
        
        # å®‰å…¨è·å–æè¿°æ˜ å°„
        å¹³æ»‘åº¦æè¿° = TRANSITION_SMOOTHNESS_DESCRIPTIONS.get(å¹³æ»‘åº¦, "å¹³æ»‘è‡ªç„¶")
        èŠ‚å¥æè¿° = TRANSITION_RHYTHM_DESCRIPTIONS.get(èŠ‚å¥, "ç¼“å…¥ç¼“å‡º")
        
        # æ ¼å¼åŒ–æ—¶é•¿ï¼Œä¿ç•™ä¸€ä½å°æ•°
        æ—¶é•¿æ ¼å¼åŒ– = f"{æ—¶é•¿:.1f}"
        
        # æ ¹æ®ä¸»è¦è½¬åœºæ–¹å¼ç”Ÿæˆå¯¹åº”çš„æç¤ºè¯
        if ä¸»è¦æ–¹å¼ == "è¿é•œæç¤ºè¯è½¬åœº":
            åŸºç¡€æç¤ºè¯ = self._generate_motion_transition(è¿åŠ¨å­ç±»å‹, è¿åŠ¨æ–¹å‘, æ—¶é•¿æ ¼å¼åŒ–, å¹³æ»‘åº¦æè¿°, èŠ‚å¥æè¿°)
            
        elif ä¸»è¦æ–¹å¼ == "äº¤å‰æº¶è§£è½¬åœº":
            åŸºç¡€æç¤ºè¯ = f"é€šè¿‡æŸ”å’Œçš„äº¤å‰æº¶è§£æ•ˆæœè‡ªç„¶è½¬åœºï¼Œæº¶è§£æ—¶é•¿çº¦{æ—¶é•¿æ ¼å¼åŒ–}ç§’ï¼Œ{å¹³æ»‘åº¦æè¿°}ï¼Œ{èŠ‚å¥æè¿°}"
            
        elif ä¸»è¦æ–¹å¼ == "è¿åŠ¨åŒ¹é…è½¬åœº":
            æ–¹å‘æè¿° = f"å‘{è¿åŠ¨æ–¹å‘}" if è¿åŠ¨æ–¹å‘ and è¿åŠ¨æ–¹å‘ != "æ— " else ""
            è¿åŠ¨æè¿° = è¿åŠ¨å­ç±»å‹ if è¿åŠ¨å­ç±»å‹ and è¿åŠ¨å­ç±»å‹ != "æ— " else "é•œå¤´è¿åŠ¨"
            åŸºç¡€æç¤ºè¯ = f"ä¿æŒ{è¿åŠ¨æè¿°}{æ–¹å‘æè¿°}çš„è¿è´¯æ€§ï¼Œ{èŠ‚å¥æè¿°}æ— ç¼è¡”æ¥ï¼Œ{å¹³æ»‘åº¦æè¿°}"
            
        elif ä¸»è¦æ–¹å¼ == "å½¢æ€å˜å½¢è½¬åœº":
            åŸºç¡€æç¤ºè¯ = self._generate_morph_transition(å˜å½¢å­ç±»å‹, æ—¶é•¿æ ¼å¼åŒ–, å¹³æ»‘åº¦æè¿°)
            
        elif ä¸»è¦æ–¹å¼ == "é®æŒ¡ç‰©è½¬åœº":
            # ä¿®æ”¹ï¼šä¼ é€’å‰æ™¯é®æŒ¡ç‰©å‚æ•°
            åŸºç¡€æç¤ºè¯ = self._generate_occlusion_transition(é®æŒ¡ç‰©ç±»å‹, æ—¶é•¿æ ¼å¼åŒ–, èŠ‚å¥æè¿°, è¿åŠ¨å­ç±»å‹, è¿åŠ¨æ–¹å‘, å‰æ™¯é®æŒ¡ç‰©)
            
        elif ä¸»è¦æ–¹å¼ == "ä¸»ä½“å˜å½¢è½¬åœº":
            åŸºç¡€æç¤ºè¯ = self._generate_subject_morph_transition(é¦–å¸§ä¸»ä½“, å°¾å¸§ä¸»ä½“, æ—¶é•¿æ ¼å¼åŒ–, å¹³æ»‘åº¦æè¿°, èŠ‚å¥æè¿°)
            
        elif ä¸»è¦æ–¹å¼ == "ç”»é¢æ¸å˜è½¬åœº":
            åŸºç¡€æç¤ºè¯ = self._generate_scene_transition(é¦–å¸§ä¸»ä½“, å°¾å¸§ä¸»ä½“, æ—¶é•¿æ ¼å¼åŒ–, å¹³æ»‘åº¦æè¿°, èŠ‚å¥æè¿°)
            
        elif ä¸»è¦æ–¹å¼ == "ä¸»ä½“é®æŒ¡è½¬åœº":
            åŸºç¡€æç¤ºè¯ = self._generate_subject_occlusion_transition(é¦–å¸§ä¸»ä½“, å°¾å¸§ä¸»ä½“, æ—¶é•¿æ ¼å¼åŒ–, èŠ‚å¥æè¿°)
            
        elif ä¸»è¦æ–¹å¼ == "å¤šé‡è½¬åœºç»„åˆ":
            åŸºç¡€æç¤ºè¯ = self._generate_multi_transition(è¿åŠ¨å­ç±»å‹, å˜å½¢å­ç±»å‹, æ—¶é•¿æ ¼å¼åŒ–, å¹³æ»‘åº¦æè¿°, èŠ‚å¥æè¿°)
            
        elif ä¸»è¦æ–¹å¼ == "äººç‰©åˆ°äººç‰©å˜åŒ–":
            åŸºç¡€æç¤ºè¯ = self._generate_character_change_transition(äººç‰©å˜åŒ–ç±»å‹, é¦–å¸§ä¸»ä½“, å°¾å¸§ä¸»ä½“, æ—¶é•¿æ ¼å¼åŒ–, å¹³æ»‘åº¦æè¿°, èŠ‚å¥æè¿°)
        
        elif ä¸»è¦æ–¹å¼ == "ç”»å·å±•å¼€å¼è½¬åœº":
            åŸºç¡€æç¤ºè¯ = self._generate_unfold_transition(å±•å¼€æ–¹å¼, æ—¶é•¿æ ¼å¼åŒ–, èŠ‚å¥æè¿°, å‰æ™¯é®æŒ¡ç‰©, é¦–å¸§ä¸»ä½“)
        
        else:
            åŸºç¡€æç¤ºè¯ = ""

        # æ³¨æ„ï¼šè§†è§‰è¿è´¯æ€§æè¿°ç°åœ¨åœ¨å®Œæ•´æç¤ºè¯ç”Ÿæˆæ—¶å¤„ç†ï¼Œä¸åœ¨è½¬åœºæç¤ºè¯ä¸­æ·»åŠ 
        return åŸºç¡€æç¤ºè¯

    def _generate_subject_morph_transition(self, é¦–å¸§ä¸»ä½“, å°¾å¸§ä¸»ä½“, æ—¶é•¿, å¹³æ»‘åº¦, èŠ‚å¥):
        """ç”Ÿæˆä¸»ä½“å˜å½¢è½¬åœºæç¤ºè¯"""
        return f"{é¦–å¸§ä¸»ä½“}é€šè¿‡æµç•…çš„å½¢æ€å˜å½¢è¿‡ç¨‹é€æ¸æ¼”å˜ä¸º{å°¾å¸§ä¸»ä½“}ï¼Œå†æ—¶{æ—¶é•¿}ç§’ï¼Œå˜å½¢è¿‡ç¨‹{å¹³æ»‘åº¦}ï¼Œ{èŠ‚å¥}"

    def _generate_scene_transition(self, é¦–å¸§ä¸»ä½“, å°¾å¸§ä¸»ä½“, æ—¶é•¿, å¹³æ»‘åº¦, èŠ‚å¥):
        """ç”Ÿæˆç”»é¢æ¸å˜è½¬åœºæç¤ºè¯"""
        return f"ä»{é¦–å¸§ä¸»ä½“}é€šè¿‡è‡ªç„¶çš„æ¸å˜æ•ˆæœè½¬åœºåˆ°{å°¾å¸§ä¸»ä½“}ï¼Œå†æ—¶{æ—¶é•¿}ç§’ï¼Œè½¬åœºè¿‡ç¨‹{å¹³æ»‘åº¦}ï¼Œ{èŠ‚å¥}"

    def _generate_subject_occlusion_transition(self, é¦–å¸§ä¸»ä½“, å°¾å¸§ä¸»ä½“, æ—¶é•¿, èŠ‚å¥):
        """ç”Ÿæˆä¸»ä½“é®æŒ¡è½¬åœºæç¤ºè¯"""
        return f"åˆ©ç”¨{é¦–å¸§ä¸»ä½“}ç§»åŠ¨åˆ°é•œå¤´å‰å®Œå…¨é®æŒ¡ç”»é¢çš„ç¬é—´åˆ‡æ¢åˆ°{å°¾å¸§ä¸»ä½“}ï¼Œå†æ—¶{æ—¶é•¿}ç§’ï¼Œ{èŠ‚å¥}"

    def _generate_multi_transition(self, è¿åŠ¨å­ç±»å‹, å˜å½¢å­ç±»å‹, æ—¶é•¿, å¹³æ»‘åº¦, èŠ‚å¥):
        """ç”Ÿæˆå¤šé‡è½¬åœºç»„åˆæç¤ºè¯"""
        è¿åŠ¨éƒ¨åˆ† = "é•œå¤´è¿åŠ¨" if not è¿åŠ¨å­ç±»å‹ or è¿åŠ¨å­ç±»å‹ == "æ— " else è¿åŠ¨å­ç±»å‹
        å˜å½¢éƒ¨åˆ† = "å½¢æ€å˜å½¢" if not å˜å½¢å­ç±»å‹ or å˜å½¢å­ç±»å‹ == "æ— " else å˜å½¢å­ç±»å‹
        return f"é¦–å…ˆé€šè¿‡{è¿åŠ¨éƒ¨åˆ†}å¼€å§‹å˜åŒ–ï¼Œä¸­é€”ç»“åˆ{å˜å½¢éƒ¨åˆ†}å¼ºåŒ–æ•ˆæœï¼Œå†æ—¶{æ—¶é•¿}ç§’ï¼Œ{å¹³æ»‘åº¦}ï¼Œ{èŠ‚å¥}ï¼Œæ•´ä¸ªè¿‡ç¨‹æµç•…å¦‚ä¸€ä½“"

    def _generate_character_change_transition(self, å˜åŒ–ç±»å‹, é¦–å¸§äººç‰©, å°¾å¸§äººç‰©, æ—¶é•¿, å¹³æ»‘åº¦, èŠ‚å¥):
        """ç”Ÿæˆäººç‰©åˆ°äººç‰©å˜åŒ–è½¬åœºæç¤ºè¯"""
        if å˜åŒ–ç±»å‹ == "æ— ":
            return f"ä»{é¦–å¸§äººç‰©}å˜åŒ–ä¸º{å°¾å¸§äººç‰©}ï¼Œå†æ—¶{æ—¶é•¿}ç§’ï¼Œ{å¹³æ»‘åº¦}ï¼Œ{èŠ‚å¥}"
        
        # è·å–äººç‰©å˜åŒ–æè¿°
        å˜åŒ–æè¿° = CHARACTER_CHANGE_DESCRIPTIONS.get(å˜åŒ–ç±»å‹, f"ä»{é¦–å¸§äººç‰©}å˜åŒ–ä¸º{å°¾å¸§äººç‰©}")
        return f"{å˜åŒ–æè¿°}ï¼Œå†æ—¶{æ—¶é•¿}ç§’ï¼Œå˜åŒ–è¿‡ç¨‹{å¹³æ»‘åº¦}ï¼Œ{èŠ‚å¥}"

    def _generate_technical_note(self, ä¸»è¦æ–¹å¼, æ—¶é•¿, å¹³æ»‘åº¦, èŠ‚å¥, è¿è´¯æ€§, é¦–å¸§ä¸»ä½“, å°¾å¸§ä¸»ä½“, äººç‰©å˜åŒ–ç±»å‹="", å‰æ™¯é®æŒ¡ç‰©="", å±•å¼€æ–¹å¼=""):
        """ç”ŸæˆæŠ€æœ¯è¯´æ˜"""
        æŠ€æœ¯è¦ç‚¹ = []
        
        if ä¸»è¦æ–¹å¼ and ä¸»è¦æ–¹å¼ != "æ— ":
            # æ ¼å¼åŒ–æ—¶é•¿ï¼Œä¿ç•™ä¸€ä½å°æ•°
            æ—¶é•¿æ ¼å¼åŒ– = f"{æ—¶é•¿:.1f}"
            æŠ€æœ¯è¦ç‚¹.append(f"è½¬åœºæ—¶é•¿: {æ—¶é•¿æ ¼å¼åŒ–}ç§’")
            æŠ€æœ¯è¦ç‚¹.append(f"è¿åŠ¨è´¨é‡: {å¹³æ»‘åº¦}")
            æŠ€æœ¯è¦ç‚¹.append(f"èŠ‚å¥æ§åˆ¶: {èŠ‚å¥}")
        
        # è§†è§‰è¿è´¯æ€§ä¿¡æ¯
        if è¿è´¯æ€§ and è¿è´¯æ€§ != "æ— ":
            æŠ€æœ¯è¦ç‚¹.append(f"è§†è§‰è¿è´¯æ€§: {è¿è´¯æ€§}")
        
        # æ–°å¢ä¸»ä½“ä¿¡æ¯ï¼ˆå¦‚æœä¸»ä½“ä¸æ˜¯é»˜è®¤å€¼ï¼‰
        if é¦–å¸§ä¸»ä½“ and é¦–å¸§ä¸»ä½“ != "å›¾åƒ1ä¸»ä½“":
            æŠ€æœ¯è¦ç‚¹.append(f"é¦–å¸§ä¸»ä½“: {é¦–å¸§ä¸»ä½“}")
        if å°¾å¸§ä¸»ä½“ and å°¾å¸§ä¸»ä½“ != "å›¾åƒ2ä¸»ä½“":
            æŠ€æœ¯è¦ç‚¹.append(f"å°¾å¸§ä¸»ä½“: {å°¾å¸§ä¸»ä½“}")
        
        # å‰æ™¯é®æŒ¡ç‰©ä¿¡æ¯ï¼ˆå¦‚æœæä¾›äº†ï¼‰
        if å‰æ™¯é®æŒ¡ç‰©:
            æŠ€æœ¯è¦ç‚¹.append(f"å‰æ™¯é®æŒ¡ç‰©: {å‰æ™¯é®æŒ¡ç‰©}")
        
        # å±•å¼€æ–¹å¼ä¿¡æ¯ï¼ˆå¦‚æœæ˜¯ç”»å·å±•å¼€å¼è½¬åœºï¼‰
        if ä¸»è¦æ–¹å¼ == "ç”»å·å±•å¼€å¼è½¬åœº" and å±•å¼€æ–¹å¼:
            æŠ€æœ¯è¦ç‚¹.append(f"å±•å¼€æ–¹å¼: {å±•å¼€æ–¹å¼}")
        
        # äººç‰©å˜åŒ–ç±»å‹ä¿¡æ¯
        if ä¸»è¦æ–¹å¼ == "äººç‰©åˆ°äººç‰©å˜åŒ–" and äººç‰©å˜åŒ–ç±»å‹ and äººç‰©å˜åŒ–ç±»å‹ != "æ— ":
            æŠ€æœ¯è¦ç‚¹.append(f"å˜åŒ–ç±»å‹: {äººç‰©å˜åŒ–ç±»å‹}")
        
        if ä¸»è¦æ–¹å¼ in ["è¿é•œæç¤ºè¯è½¬åœº", "è¿åŠ¨åŒ¹é…è½¬åœº"]:
            æŠ€æœ¯è¦ç‚¹.append("å»ºè®®ä½¿ç”¨ä¸€è‡´çš„æ‘„åƒæœºè¿åŠ¨å‚æ•°")
        
        if ä¸»è¦æ–¹å¼ == "äº¤å‰æº¶è§£è½¬åœº":
            æŠ€æœ¯è¦ç‚¹.append("ç¡®ä¿é¦–å°¾å¸§è‰²å½©å’Œå…‰ç…§é£æ ¼ä¸€è‡´")
        
        if ä¸»è¦æ–¹å¼ == "å½¢æ€å˜å½¢è½¬åœº":
            æŠ€æœ¯è¦ç‚¹.append("éœ€è¦ç›¸ä¼¼çš„ä¸»ä½“å½¢çŠ¶ä»¥è·å¾—æœ€ä½³æ•ˆæœ")
        
        if ä¸»è¦æ–¹å¼ in ["ä¸»ä½“å˜å½¢è½¬åœº", "ä¸»ä½“é®æŒ¡è½¬åœº"]:
            æŠ€æœ¯è¦ç‚¹.append("éœ€è¦æ¸…æ™°çš„ä¸»ä½“å®šä¹‰")
        
        if ä¸»è¦æ–¹å¼ == "äººç‰©åˆ°äººç‰©å˜åŒ–":
            æŠ€æœ¯è¦ç‚¹.append("ä¿æŒäººç‰©æ¯”ä¾‹å’Œå§¿æ€çš„ä¸€è‡´æ€§")
        
        if ä¸»è¦æ–¹å¼ == "ç”»å·å±•å¼€å¼è½¬åœº":
            æŠ€æœ¯è¦ç‚¹.append("ç¡®ä¿å±•å¼€åŠ¨ä½œä¸ç”»é¢è¿‡æ¸¡åŒæ­¥")
        
        return " | ".join(æŠ€æœ¯è¦ç‚¹) if æŠ€æœ¯è¦ç‚¹ else "æ— ç‰¹æ®ŠæŠ€æœ¯è¦æ±‚"


class è§†é¢‘é¦–å°¾å¸§è½¬åœº_å¢å¼ºç‰ˆ(è§†é¢‘è½¬åœºåŸºç±»):
    @classmethod
    def INPUT_TYPES(cls):
        return {
            "required": {
                "é¦–å¸§æè¿°_å»ºè®®å¡«å†™": ("STRING", {
                    "multiline": False,
                    "default": "",
                    "display_name": "é¦–å¸§æè¿°-éå¿…å¡«"
                }),
                "å°¾å¸§æè¿°_å»ºè®®å¡«å†™": ("STRING", {
                    "multiline": False,
                    "default": "",
                    "display_name": "å°¾å¸§æè¿°-éå¿…å¡«"
                }),
                "ä¸»è¦è½¬åœºæ–¹å¼": (TRANSITION_TYPES, {
                    "default": "è¿é•œæç¤ºè¯è½¬åœº",
                    "display_name": "ä¸»è¦è½¬åœºæ–¹å¼"
                }),
                "è½¬åœºæ—¶é•¿": ("FLOAT", {
                    "default": 3.0,
                    "min": 1.0,
                    "max": 10.0,
                    "step": 0.1,
                    "display": "slider",
                    "display_name": "è½¬åœºæ—¶é•¿(ç§’)"
                }),
                "è¿åŠ¨å¹³æ»‘åº¦": (TRANSITION_SMOOTHNESS, {
                    "default": "å¹³æ»‘",
                    "display_name": "è¿åŠ¨å¹³æ»‘åº¦"
                }),
            },
            "optional": {
                # æ–°å¢äººç‰©åŠ¨æ€æ•ˆæœç»„ä»¶
                "äººç‰©åŠ¨æ€æ•ˆæœ": (CHARACTER_DYNAMIC_EFFECTS, {
                    "default": "æ— ",
                    "display_name": "äººç‰©åŠ¨æ€æ•ˆæœ"
                }),
                "äººç‰©æ•ˆæœå¼ºåº¦": (EFFECT_INTENSITY, {
                    "default": "é€‚ä¸­",
                    "display_name": "äººç‰©æ•ˆæœå¼ºåº¦"
                }),
                
                # æ–°å¢ç¯å¢ƒåŠ¨æ€æ•ˆæœç»„ä»¶
                "ç¯å¢ƒåŠ¨æ€æ•ˆæœ": (ENVIRONMENT_DYNAMIC_EFFECTS, {
                    "default": "æ— ",
                    "display_name": "ç¯å¢ƒåŠ¨æ€æ•ˆæœ"
                }),
                "ç¯å¢ƒæ•ˆæœå¼ºåº¦": (EFFECT_INTENSITY, {
                    "default": "é€‚ä¸­",
                    "display_name": "ç¯å¢ƒæ•ˆæœå¼ºåº¦"
                }),
                
                # è¿é•œæ–¹å¼ç»„ä»¶
                "è¿é•œæ–¹å¼": (CAMERA_MOVEMENTS, {
                    "default": "æ— ",
                    "display_name": "è¿é•œæ–¹å¼"
                }),
                
                # è¿åŠ¨è½¬åœºä¸“ç”¨å‚æ•°
                "è¿åŠ¨å­ç±»å‹": (MOTION_TRANSITION_SUBTYPES, {
                    "default": "ç¼©æ”¾è½¬åœº",
                    "display_name": "è¿åŠ¨å­ç±»å‹"
                }),
                "è¿åŠ¨æ–¹å‘": (MOTION_DIRECTIONS, {
                    "default": "å‘å‰",
                    "display_name": "è¿åŠ¨æ–¹å‘"
                }),
                
                # å˜å½¢è½¬åœºä¸“ç”¨å‚æ•°
                "å˜å½¢å­ç±»å‹": (MORPH_TRANSITION_SUBTYPES, {
                    "default": "æœ‰æœºå˜å½¢",
                    "display_name": "å˜å½¢å­ç±»å‹"
                }),
                
                # é®æŒ¡ç‰©è½¬åœºä¸“ç”¨å‚æ•°
                "é®æŒ¡ç‰©ç±»å‹": (OCCLUSION_TYPES, {
                    "default": "å‰æ™¯ç‰©ä½“é®æŒ¡",
                    "display_name": "é®æŒ¡ç‰©ç±»å‹"
                }),
                # æ–°å¢ï¼šå‰æ™¯é®æŒ¡ç‰©ç»„ä»¶
                "å‰æ™¯é®æŒ¡ç‰©": ("STRING", {
                    "multiline": False,
                    "default": "",
                    "display_name": "å‰æ™¯é®æŒ¡ç‰©"
                }),
                
                # ç”»å·å±•å¼€å¼è½¬åœºä¸“ç”¨å‚æ•°
                "å±•å¼€æ–¹å¼": ([
                    "äººç‰©å±•å¼€", "ç‰©ä½“å±•å¼€", "ç”»å·å±•å¼€", "é—¨çª—å±•å¼€", "å¯¹ç§°å±•å¼€"
                ], {
                    "default": "ç”»å·å±•å¼€",
                    "display_name": "å±•å¼€æ–¹å¼"
                }),
                
                # äººç‰©å˜åŒ–ä¸“ç”¨å‚æ•°
                "äººç‰©å˜åŒ–ç±»å‹": (CHARACTER_CHANGE_TYPES, {
                    "default": "å½¢æ€å˜å½¢",
                    "display_name": "äººç‰©å˜åŒ–ç±»å‹"
                }),
                
                # é€šç”¨å¯é€‰å‚æ•°
                "è½¬åœºèŠ‚å¥": (TRANSITION_RHYTHMS, {
                    "default": "ç¼“å…¥ç¼“å‡º",
                    "display_name": "è½¬åœºèŠ‚å¥"
                }),
                "è§†è§‰è¿è´¯æ€§": (VISUAL_CONSISTENCY, {
                    "default": "é£æ ¼ç»Ÿä¸€",
                    "display_name": "è§†è§‰è¿è´¯æ€§"
                }),
                "é™„åŠ è½¬åœºæè¿°": ("STRING", {
                    "multiline": True,
                    "default": "åŠ¨ä½œæµç•…",
                    "display_name": "é™„åŠ è½¬åœºæè¿°"
                }),
            }
        }
    
    RETURN_TYPES = ("STRING", "STRING", "STRING")
    RETURN_NAMES = ("è½¬åœºæç¤ºè¯", "å®Œæ•´æç¤ºè¯", "æŠ€æœ¯è¯´æ˜")
    FUNCTION = "ç”Ÿæˆè½¬åœºæç¤ºè¯"
    CATEGORY = "ğŸ“•æç¤ºè¯å…¬å¼/å›¾è½¬è§†é¢‘"

    def ç”Ÿæˆè½¬åœºæç¤ºè¯(self, é¦–å¸§æè¿°_å»ºè®®å¡«å†™, å°¾å¸§æè¿°_å»ºè®®å¡«å†™, ä¸»è¦è½¬åœºæ–¹å¼, è½¬åœºæ—¶é•¿, è¿åŠ¨å¹³æ»‘åº¦,
                    äººç‰©åŠ¨æ€æ•ˆæœ="æ— ", äººç‰©æ•ˆæœå¼ºåº¦="é€‚ä¸­",  # æ–°å¢å‚æ•°
                    ç¯å¢ƒåŠ¨æ€æ•ˆæœ="æ— ", ç¯å¢ƒæ•ˆæœå¼ºåº¦="é€‚ä¸­",  # æ–°å¢å‚æ•°
                    è¿é•œæ–¹å¼="æ— ",
                    è¿åŠ¨å­ç±»å‹="ç¼©æ”¾è½¬åœº", è¿åŠ¨æ–¹å‘="å‘å‰", å˜å½¢å­ç±»å‹="æœ‰æœºå˜å½¢",
                    é®æŒ¡ç‰©ç±»å‹="å‰æ™¯ç‰©ä½“é®æŒ¡", å‰æ™¯é®æŒ¡ç‰©="", å±•å¼€æ–¹å¼="ç”»å·å±•å¼€",
                    äººç‰©å˜åŒ–ç±»å‹="å½¢æ€å˜å½¢",
                    è½¬åœºèŠ‚å¥="ç¼“å…¥ç¼“å‡º", è§†è§‰è¿è´¯æ€§="é£æ ¼ç»Ÿä¸€", é™„åŠ è½¬åœºæè¿°=""):
        
        try:
            # æ¸…ç†è¾“å…¥æ–‡æœ¬
            é¦–å¸§æè¿°_å»ºè®®å¡«å†™_æ¸…ç† = clean_text(é¦–å¸§æè¿°_å»ºè®®å¡«å†™)
            å°¾å¸§æè¿°_å»ºè®®å¡«å†™_æ¸…ç† = clean_text(å°¾å¸§æè¿°_å»ºè®®å¡«å†™)
            é™„åŠ æè¿°_æ¸…ç† = clean_text(é™„åŠ è½¬åœºæè¿°)
            å‰æ™¯é®æŒ¡ç‰©_æ¸…ç† = clean_text(å‰æ™¯é®æŒ¡ç‰©)
            
            # è‡ªåŠ¨æå–ä¸»ä½“ï¼ˆä¼˜å…ˆä»å¼•å·ä¸­æå–ï¼‰
            é¦–å¸§ä¸»ä½“_æ¸…ç† = self._extract_subject_with_quotes(é¦–å¸§æè¿°_å»ºè®®å¡«å†™_æ¸…ç†)
            å°¾å¸§ä¸»ä½“_æ¸…ç† = self._extract_subject_with_quotes(å°¾å¸§æè¿°_å»ºè®®å¡«å†™_æ¸…ç†)
            
            # å¯¹äºäººç‰©åˆ°äººç‰©å˜åŒ–ï¼Œç‰¹åˆ«ä¼˜åŒ–ä¸»ä½“æå–
            if ä¸»è¦è½¬åœºæ–¹å¼ == "äººç‰©åˆ°äººç‰©å˜åŒ–":
                é¦–å¸§ä¸»ä½“_æ¸…ç† = self._extract_character_subject(é¦–å¸§æè¿°_å»ºè®®å¡«å†™_æ¸…ç†, é¦–å¸§ä¸»ä½“_æ¸…ç†)
                å°¾å¸§ä¸»ä½“_æ¸…ç† = self._extract_character_subject(å°¾å¸§æè¿°_å»ºè®®å¡«å†™_æ¸…ç†, å°¾å¸§ä¸»ä½“_æ¸…ç†)
            
            # ç¡®ä¿ä¸»ä½“ä¸ä¸ºç©º
            é¦–å¸§ä¸»ä½“_æ¸…ç† = é¦–å¸§ä¸»ä½“_æ¸…ç† or "å›¾åƒ1ä¸»ä½“"
            å°¾å¸§ä¸»ä½“_æ¸…ç† = å°¾å¸§ä¸»ä½“_æ¸…ç† or "å›¾åƒ2ä¸»ä½“"
            
            # æ ¹æ®è½¬åœºæ–¹å¼ç”Ÿæˆå¯¹åº”çš„æç¤ºè¯
            è½¬åœºæç¤ºè¯ = self._generate_transition_prompt(
                ä¸»è¦è½¬åœºæ–¹å¼, è¿åŠ¨å­ç±»å‹, è¿åŠ¨æ–¹å‘, å˜å½¢å­ç±»å‹, é®æŒ¡ç‰©ç±»å‹,
                äººç‰©å˜åŒ–ç±»å‹, è½¬åœºæ—¶é•¿, è¿åŠ¨å¹³æ»‘åº¦, è½¬åœºèŠ‚å¥, è§†è§‰è¿è´¯æ€§,
                é¦–å¸§ä¸»ä½“_æ¸…ç†, å°¾å¸§ä¸»ä½“_æ¸…ç†, è¿é•œæ–¹å¼, å‰æ™¯é®æŒ¡ç‰©_æ¸…ç†, å±•å¼€æ–¹å¼
            )
            
            # ç”Ÿæˆäººç‰©åŠ¨æ€æ•ˆæœæç¤ºè¯ï¼ˆå¦‚æœé€‰æ‹©äº†äººç‰©åŠ¨æ€æ•ˆæœï¼‰
            äººç‰©æ•ˆæœæç¤ºè¯ = self._generate_character_effect_prompt(
                äººç‰©åŠ¨æ€æ•ˆæœ, äººç‰©æ•ˆæœå¼ºåº¦, è½¬åœºæ—¶é•¿
            )
            
            # ç”Ÿæˆç¯å¢ƒåŠ¨æ€æ•ˆæœæç¤ºè¯ï¼ˆå¦‚æœé€‰æ‹©äº†ç¯å¢ƒåŠ¨æ€æ•ˆæœï¼‰
            ç¯å¢ƒæ•ˆæœæç¤ºè¯ = self._generate_environment_effect_prompt(
                ç¯å¢ƒåŠ¨æ€æ•ˆæœ, ç¯å¢ƒæ•ˆæœå¼ºåº¦, è½¬åœºæ—¶é•¿
            )
            
            # ç”Ÿæˆå®Œæ•´æç¤ºè¯ï¼ˆå°†è½¬åœºæç¤ºè¯å’ŒåŠ¨æ€æ•ˆæœæç¤ºè¯åˆå¹¶ï¼‰
            # ä¿®æ”¹ï¼šä½¿ç”¨æ–°çš„å®Œæ•´æç¤ºè¯ç”Ÿæˆæ–¹æ³•ï¼Œå°†å°¾å¸§æè¿°æ”¾åœ¨è§†è§‰è¿è´¯æ€§æè¿°çš„åé¢
            å®Œæ•´æç¤ºè¯ = self._generate_full_prompt_with_effects_and_visual_consistency(
                é¦–å¸§æè¿°_å»ºè®®å¡«å†™_æ¸…ç†, å°¾å¸§æè¿°_å»ºè®®å¡«å†™_æ¸…ç†, 
                è½¬åœºæç¤ºè¯, è§†è§‰è¿è´¯æ€§, äººç‰©æ•ˆæœæç¤ºè¯, ç¯å¢ƒæ•ˆæœæç¤ºè¯, é™„åŠ æè¿°_æ¸…ç†
            )
            
            # ç”ŸæˆæŠ€æœ¯è¯´æ˜
            æŠ€æœ¯è¯´æ˜ = self._generate_technical_note_enhanced(
                ä¸»è¦è½¬åœºæ–¹å¼, è½¬åœºæ—¶é•¿, è¿åŠ¨å¹³æ»‘åº¦, è½¬åœºèŠ‚å¥, è§†è§‰è¿è´¯æ€§,
                é¦–å¸§ä¸»ä½“_æ¸…ç†, å°¾å¸§ä¸»ä½“_æ¸…ç†, äººç‰©å˜åŒ–ç±»å‹, 
                è¿é•œæ–¹å¼, äººç‰©åŠ¨æ€æ•ˆæœ, äººç‰©æ•ˆæœå¼ºåº¦, ç¯å¢ƒåŠ¨æ€æ•ˆæœ, ç¯å¢ƒæ•ˆæœå¼ºåº¦,
                å‰æ™¯é®æŒ¡ç‰©_æ¸…ç†, å±•å¼€æ–¹å¼  # æ–°å¢å‚æ•°
            )
            
            # è¿”å›è½¬åœºæç¤ºè¯ï¼ˆä¸åŒ…å«åŠ¨æ€æ•ˆæœï¼‰å’Œå®Œæ•´æç¤ºè¯ï¼ˆåŒ…å«æ‰€æœ‰ï¼‰
            return (è½¬åœºæç¤ºè¯, å®Œæ•´æç¤ºè¯, æŠ€æœ¯è¯´æ˜)
            
        except Exception as e:
            logging.error(f"è§†é¢‘é¦–å°¾å¸§è½¬åœº-å¢å¼ºç‰ˆç”Ÿæˆé”™è¯¯: {str(e)}")
            error_msg = f"ç”Ÿæˆè½¬åœºæç¤ºè¯æ—¶å‡ºé”™: {str(e)}"
            return (error_msg, error_msg, error_msg)

    def _generate_transition_prompt(self, ä¸»è¦æ–¹å¼, è¿åŠ¨å­ç±»å‹, è¿åŠ¨æ–¹å‘, å˜å½¢å­ç±»å‹, 
                                  é®æŒ¡ç‰©ç±»å‹, äººç‰©å˜åŒ–ç±»å‹, æ—¶é•¿, å¹³æ»‘åº¦, èŠ‚å¥, è¿è´¯æ€§,
                                  é¦–å¸§ä¸»ä½“, å°¾å¸§ä¸»ä½“, è¿é•œæ–¹å¼="æ— ", å‰æ™¯é®æŒ¡ç‰©=None, å±•å¼€æ–¹å¼="ç”»å·å±•å¼€"):
        """ç”Ÿæˆå…·ä½“çš„è½¬åœºæç¤ºè¯"""
        
        # å¦‚æœä¸»è¦è½¬åœºæ–¹å¼ä¸º"æ— "ï¼Œç›´æ¥è¿”å›ç©ºå­—ç¬¦ä¸²
        if ä¸»è¦æ–¹å¼ == "æ— ":
            return ""
        
        # å®‰å…¨è·å–æè¿°æ˜ å°„
        å¹³æ»‘åº¦æè¿° = TRANSITION_SMOOTHNESS_DESCRIPTIONS.get(å¹³æ»‘åº¦, "å¹³æ»‘è‡ªç„¶")
        èŠ‚å¥æè¿° = TRANSITION_RHYTHM_DESCRIPTIONS.get(èŠ‚å¥, "ç¼“å…¥ç¼“å‡º")
        
        # æ ¼å¼åŒ–æ—¶é•¿ï¼Œä¿ç•™ä¸€ä½å°æ•°
        æ—¶é•¿æ ¼å¼åŒ– = f"{æ—¶é•¿:.1f}"
        
        # æ ¹æ®ä¸»è¦è½¬åœºæ–¹å¼ç”Ÿæˆå¯¹åº”çš„æç¤ºè¯
        if ä¸»è¦æ–¹å¼ == "è¿é•œæç¤ºè¯è½¬åœº":
            åŸºç¡€æç¤ºè¯ = self._generate_motion_transition(è¿åŠ¨å­ç±»å‹, è¿åŠ¨æ–¹å‘, æ—¶é•¿æ ¼å¼åŒ–, å¹³æ»‘åº¦æè¿°, èŠ‚å¥æè¿°)
            
        elif ä¸»è¦æ–¹å¼ == "äº¤å‰æº¶è§£è½¬åœº":
            åŸºç¡€æç¤ºè¯ = f"é€šè¿‡æŸ”å’Œçš„äº¤å‰æº¶è§£æ•ˆæœè‡ªç„¶è½¬åœºï¼Œæº¶è§£æ—¶é•¿çº¦{æ—¶é•¿æ ¼å¼åŒ–}ç§’ï¼Œ{å¹³æ»‘åº¦æè¿°}ï¼Œ{èŠ‚å¥æè¿°}"
            
        elif ä¸»è¦æ–¹å¼ == "è¿åŠ¨åŒ¹é…è½¬åœº":
            æ–¹å‘æè¿° = f"å‘{è¿åŠ¨æ–¹å‘}" if è¿åŠ¨æ–¹å‘ and è¿åŠ¨æ–¹å‘ != "æ— " else ""
            è¿åŠ¨æè¿° = è¿åŠ¨å­ç±»å‹ if è¿åŠ¨å­ç±»å‹ and è¿åŠ¨å­ç±»å‹ != "æ— " else "é•œå¤´è¿åŠ¨"
            åŸºç¡€æç¤ºè¯ = f"ä¿æŒ{è¿åŠ¨æè¿°}{æ–¹å‘æè¿°}çš„è¿è´¯æ€§ï¼Œ{èŠ‚å¥æè¿°}æ— ç¼è¡”æ¥ï¼Œ{å¹³æ»‘åº¦æè¿°}"
            
        elif ä¸»è¦æ–¹å¼ == "å½¢æ€å˜å½¢è½¬åœº":
            åŸºç¡€æç¤ºè¯ = self._generate_morph_transition(å˜å½¢å­ç±»å‹, æ—¶é•¿æ ¼å¼åŒ–, å¹³æ»‘åº¦æè¿°)
            
        elif ä¸»è¦æ–¹å¼ == "é®æŒ¡ç‰©è½¬åœº":
            # ä¿®æ”¹ï¼šä¼ é€’å‰æ™¯é®æŒ¡ç‰©å‚æ•°
            åŸºç¡€æç¤ºè¯ = self._generate_occlusion_transition(é®æŒ¡ç‰©ç±»å‹, æ—¶é•¿æ ¼å¼åŒ–, èŠ‚å¥æè¿°, è¿åŠ¨å­ç±»å‹, è¿åŠ¨æ–¹å‘, å‰æ™¯é®æŒ¡ç‰©)
            
        elif ä¸»è¦æ–¹å¼ == "ä¸»ä½“å˜å½¢è½¬åœº":
            åŸºç¡€æç¤ºè¯ = self._generate_subject_morph_transition(é¦–å¸§ä¸»ä½“, å°¾å¸§ä¸»ä½“, æ—¶é•¿æ ¼å¼åŒ–, å¹³æ»‘åº¦æè¿°, èŠ‚å¥æè¿°)
            
        elif ä¸»è¦æ–¹å¼ == "ç”»é¢æ¸å˜è½¬åœº":
            åŸºç¡€æç¤ºè¯ = self._generate_scene_transition(é¦–å¸§ä¸»ä½“, å°¾å¸§ä¸»ä½“, æ—¶é•¿æ ¼å¼åŒ–, å¹³æ»‘åº¦æè¿°, èŠ‚å¥æè¿°)
            
        elif ä¸»è¦æ–¹å¼ == "ä¸»ä½“é®æŒ¡è½¬åœº":
            åŸºç¡€æç¤ºè¯ = self._generate_subject_occlusion_transition(é¦–å¸§ä¸»ä½“, å°¾å¸§ä¸»ä½“, æ—¶é•¿æ ¼å¼åŒ–, èŠ‚å¥æè¿°)
            
        elif ä¸»è¦æ–¹å¼ == "å¤šé‡è½¬åœºç»„åˆ":
            åŸºç¡€æç¤ºè¯ = self._generate_multi_transition(è¿åŠ¨å­ç±»å‹, å˜å½¢å­ç±»å‹, æ—¶é•¿æ ¼å¼åŒ–, å¹³æ»‘åº¦æè¿°, èŠ‚å¥æè¿°)
            
        elif ä¸»è¦æ–¹å¼ == "äººç‰©åˆ°äººç‰©å˜åŒ–":
            åŸºç¡€æç¤ºè¯ = self._generate_character_change_transition(äººç‰©å˜åŒ–ç±»å‹, é¦–å¸§ä¸»ä½“, å°¾å¸§ä¸»ä½“, æ—¶é•¿æ ¼å¼åŒ–, å¹³æ»‘åº¦æè¿°, èŠ‚å¥æè¿°)
        
        elif ä¸»è¦æ–¹å¼ == "ç”»å·å±•å¼€å¼è½¬åœº":
            åŸºç¡€æç¤ºè¯ = self._generate_unfold_transition(å±•å¼€æ–¹å¼, æ—¶é•¿æ ¼å¼åŒ–, èŠ‚å¥æè¿°, å‰æ™¯é®æŒ¡ç‰©, é¦–å¸§ä¸»ä½“)
        
        else:
            åŸºç¡€æç¤ºè¯ = ""

        # æ·»åŠ è¿é•œæ–¹å¼ï¼ˆå¦‚æœä¸»è¦æ–¹å¼ä¸æ˜¯è¿é•œæç¤ºè¯è½¬åœºä¸”è¿é•œæ–¹å¼ä¸æ˜¯"æ— "ï¼‰
        if (ä¸»è¦æ–¹å¼ != "è¿é•œæç¤ºè¯è½¬åœº" and 
            è¿é•œæ–¹å¼ and 
            è¿é•œæ–¹å¼ != "æ— " and 
            åŸºç¡€æç¤ºè¯):
            è¿é•œæè¿° = CAMERA_MOVEMENT_DESCRIPTIONS.get(è¿é•œæ–¹å¼, è¿é•œæ–¹å¼)
            # å¦‚æœæè¿°ä¸­åŒ…å«{target}å ä½ç¬¦ï¼Œæ›¿æ¢ä¸ºè½¬åœºä¸»ä½“
            if "{target}" in è¿é•œæè¿°:
                è¿é•œæè¿° = è¿é•œæè¿°.replace("{target}", é¦–å¸§ä¸»ä½“)
            åŸºç¡€æç¤ºè¯ = f"{è¿é•œæè¿°}ï¼ŒåŒæ—¶{åŸºç¡€æç¤ºè¯}"

        # æ³¨æ„ï¼šè§†è§‰è¿è´¯æ€§æè¿°ç°åœ¨åœ¨å®Œæ•´æç¤ºè¯ç”Ÿæˆæ—¶å¤„ç†ï¼Œä¸åœ¨è½¬åœºæç¤ºè¯ä¸­æ·»åŠ 
        return åŸºç¡€æç¤ºè¯

    def _generate_full_prompt_with_effects_and_visual_consistency(self, é¦–å¸§, å°¾å¸§, è½¬åœº, è§†è§‰è¿è´¯æ€§, 
                                                                äººç‰©æ•ˆæœ="", ç¯å¢ƒæ•ˆæœ="", é™„åŠ æè¿°=""):
        """ç”Ÿæˆå®Œæ•´æç¤ºè¯ï¼ˆå°†å°¾å¸§æè¿°æ”¾åœ¨è§†è§‰è¿è´¯æ€§æè¿°çš„åé¢ï¼Œå¸¦åŠ¨æ€æ•ˆæœï¼‰"""
        ç»„ä»¶ = []
        
        # 1. æ·»åŠ é¦–å¸§æè¿°
        if é¦–å¸§:
            ç»„ä»¶.append(é¦–å¸§)
        
        # 2. å¤„ç†è½¬åœºã€è§†è§‰è¿è´¯æ€§ã€å°¾å¸§æè¿°
        è½¬åœºç»„ä»¶ = []
        if è½¬åœº:
            è½¬åœºç»„ä»¶.append(è½¬åœº)
        
            # æ·»åŠ è§†è§‰è¿è´¯æ€§æè¿°ï¼ˆå¦‚æœæœ‰è½¬åœºä¸”æœ‰è§†è§‰è¿è´¯æ€§ï¼‰
            if è§†è§‰è¿è´¯æ€§ and è§†è§‰è¿è´¯æ€§ != "æ— ":
                è¿è´¯æ€§æè¿° = self._get_visual_consistency_description(è§†è§‰è¿è´¯æ€§)
                è½¬åœºç»„ä»¶.append(è¿è´¯æ€§æè¿°)
        
        # æ·»åŠ å°¾å¸§æè¿°ï¼ˆå¦‚æœæœ‰è½¬åœºç»„ä»¶æˆ–ç›´æ¥æ·»åŠ ï¼‰
        if å°¾å¸§:
            if è½¬åœºç»„ä»¶:
                # å°†å°¾å¸§æè¿°æ·»åŠ åˆ°è½¬åœºç»„ä»¶ä¸­
                è½¬åœºç»„ä»¶.append(å°¾å¸§)
                ç»„ä»¶.append("ï¼Œ".join(è½¬åœºç»„ä»¶))
            else:
                # æ²¡æœ‰è½¬åœºï¼Œç›´æ¥æ·»åŠ å°¾å¸§
                ç»„ä»¶.append(å°¾å¸§)
        elif è½¬åœºç»„ä»¶:
            # åªæœ‰è½¬åœºæ²¡æœ‰å°¾å¸§
            ç»„ä»¶.append("ï¼Œ".join(è½¬åœºç»„ä»¶))
        
        # 3. å¤„ç†äººç‰©åŠ¨æ€æ•ˆæœï¼ˆä½œä¸ºè½¬åœºçš„è¡¥å……ï¼‰
        if äººç‰©æ•ˆæœ:
            ç»„ä»¶.append(äººç‰©æ•ˆæœ)
        
        # 4. å¤„ç†ç¯å¢ƒåŠ¨æ€æ•ˆæœï¼ˆä½œä¸ºè½¬åœºçš„è¡¥å……ï¼‰
        if ç¯å¢ƒæ•ˆæœ:
            ç»„ä»¶.append(ç¯å¢ƒæ•ˆæœ)
        
        # 5. æ·»åŠ é™„åŠ æè¿°
        if é™„åŠ æè¿°:
            ç»„ä»¶.append(é™„åŠ æè¿°)
        
        # å¦‚æœæ‰€æœ‰ç»„ä»¶éƒ½ä¸ºç©ºï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²
        if not ç»„ä»¶:
            return ""
        
        å®Œæ•´æç¤ºè¯ = "ï¼Œ".join(ç»„ä»¶)
        
        # æœ€ç»ˆæ¸…ç†
        å®Œæ•´æç¤ºè¯ = re.sub(r',\s+,', ',', å®Œæ•´æç¤ºè¯)
        å®Œæ•´æç¤ºè¯ = re.sub(r'\s+', ' ', å®Œæ•´æç¤ºè¯).strip()
        
        return å®Œæ•´æç¤ºè¯

    def _generate_subject_morph_transition(self, é¦–å¸§ä¸»ä½“, å°¾å¸§ä¸»ä½“, æ—¶é•¿, å¹³æ»‘åº¦, èŠ‚å¥):
        """ç”Ÿæˆä¸»ä½“å˜å½¢è½¬åœºæç¤ºè¯"""
        return f"{é¦–å¸§ä¸»ä½“}é€šè¿‡æµç•…çš„å½¢æ€å˜å½¢è¿‡ç¨‹é€æ¸æ¼”å˜ä¸º{å°¾å¸§ä¸»ä½“}ï¼Œå†æ—¶{æ—¶é•¿}ç§’ï¼Œå˜å½¢è¿‡ç¨‹{å¹³æ»‘åº¦}ï¼Œ{èŠ‚å¥}"

    def _generate_scene_transition(self, é¦–å¸§ä¸»ä½“, å°¾å¸§ä¸»ä½“, æ—¶é•¿, å¹³æ»‘åº¦, èŠ‚å¥):
        """ç”Ÿæˆç”»é¢æ¸å˜è½¬åœºæç¤ºè¯"""
        return f"ä»{é¦–å¸§ä¸»ä½“}é€šè¿‡è‡ªç„¶çš„æ¸å˜æ•ˆæœè½¬åœºåˆ°{å°¾å¸§ä¸»ä½“}ï¼Œå†æ—¶{æ—¶é•¿}ç§’ï¼Œè½¬åœºè¿‡ç¨‹{å¹³æ»‘åº¦}ï¼Œ{èŠ‚å¥}"

    def _generate_subject_occlusion_transition(self, é¦–å¸§ä¸»ä½“, å°¾å¸§ä¸»ä½“, æ—¶é•¿, èŠ‚å¥):
        """ç”Ÿæˆä¸»ä½“é®æŒ¡è½¬åœºæç¤ºè¯"""
        return f"åˆ©ç”¨{é¦–å¸§ä¸»ä½“}ç§»åŠ¨åˆ°é•œå¤´å‰å®Œå…¨é®æŒ¡ç”»é¢çš„ç¬é—´åˆ‡æ¢åˆ°{å°¾å¸§ä¸»ä½“}ï¼Œå†æ—¶{æ—¶é•¿}ç§’ï¼Œ{èŠ‚å¥}"

    def _generate_multi_transition(self, è¿åŠ¨å­ç±»å‹, å˜å½¢å­ç±»å‹, æ—¶é•¿, å¹³æ»‘åº¦, èŠ‚å¥):
        """ç”Ÿæˆå¤šé‡è½¬åœºç»„åˆæç¤ºè¯"""
        è¿åŠ¨éƒ¨åˆ† = "é•œå¤´è¿åŠ¨" if not è¿åŠ¨å­ç±»å‹ or è¿åŠ¨å­ç±»å‹ == "æ— " else è¿åŠ¨å­ç±»å‹
        å˜å½¢éƒ¨åˆ† = "å½¢æ€å˜å½¢" if not å˜å½¢å­ç±»å‹ or å˜å½¢å­ç±»å‹ == "æ— " else å˜å½¢å­ç±»å‹
        return f"é¦–å…ˆé€šè¿‡{è¿åŠ¨éƒ¨åˆ†}å¼€å§‹å˜åŒ–ï¼Œä¸­é€”ç»“åˆ{å˜å½¢éƒ¨åˆ†}å¼ºåŒ–æ•ˆæœï¼Œå†æ—¶{æ—¶é•¿}ç§’ï¼Œ{å¹³æ»‘åº¦}ï¼Œ{èŠ‚å¥}ï¼Œæ•´ä¸ªè¿‡ç¨‹æµç•…å¦‚ä¸€ä½“"

    def _generate_character_change_transition(self, å˜åŒ–ç±»å‹, é¦–å¸§äººç‰©, å°¾å¸§äººç‰©, æ—¶é•¿, å¹³æ»‘åº¦, èŠ‚å¥):
        """ç”Ÿæˆäººç‰©åˆ°äººç‰©å˜åŒ–è½¬åœºæç¤ºè¯"""
        if å˜åŒ–ç±»å‹ == "æ— ":
            return f"ä»{é¦–å¸§äººç‰©}å˜åŒ–ä¸º{å°¾å¸§äººç‰©}ï¼Œå†æ—¶{æ—¶é•¿}ç§’ï¼Œ{å¹³æ»‘åº¦}ï¼Œ{èŠ‚å¥}"
        
        # è·å–äººç‰©å˜åŒ–æè¿°
        å˜åŒ–æè¿° = CHARACTER_CHANGE_DESCRIPTIONS.get(å˜åŒ–ç±»å‹, f"ä»{é¦–å¸§äººç‰©}å˜åŒ–ä¸º{å°¾å¸§äººç‰©}")
        return f"{å˜åŒ–æè¿°}ï¼Œå†æ—¶{æ—¶é•¿}ç§’ï¼Œå˜åŒ–è¿‡ç¨‹{å¹³æ»‘åº¦}ï¼Œ{èŠ‚å¥}"

    def _generate_character_effect_prompt(self, äººç‰©æ•ˆæœ, æ•ˆæœå¼ºåº¦, è½¬åœºæ—¶é•¿):
        """ç”Ÿæˆäººç‰©åŠ¨æ€æ•ˆæœæç¤ºè¯"""
        if not äººç‰©æ•ˆæœ or äººç‰©æ•ˆæœ == "æ— ":
            return ""
        
        # ä»å¸¸é‡é…ç½®ä¸­è·å–äººç‰©æ•ˆæœæè¿°
        æ•ˆæœæè¿° = DYNAMIC_EFFECT_DESCRIPTIONS.get(äººç‰©æ•ˆæœ, äººç‰©æ•ˆæœ)
        
        # è·å–å¼ºåº¦æè¿°ï¼ˆä½¿ç”¨å¸¸é‡é…ç½®ï¼‰
        å¼ºåº¦æè¿° = self._get_intensity_description(æ•ˆæœå¼ºåº¦)
        
        # æ ¼å¼åŒ–æ—¶é•¿æè¿°
        æ—¶é•¿æ ¼å¼åŒ– = f"{è½¬åœºæ—¶é•¿:.1f}"
        
        # ç”Ÿæˆäººç‰©æ•ˆæœæç¤ºè¯
        return f"è¿‡ç¨‹ä¸­äººç‰©æœ‰{æ•ˆæœæè¿°}ï¼Œ{å¼ºåº¦æè¿°}ï¼ŒæŒç»­çº¦{æ—¶é•¿æ ¼å¼åŒ–}ç§’"

    def _generate_environment_effect_prompt(self, ç¯å¢ƒæ•ˆæœ, æ•ˆæœå¼ºåº¦, è½¬åœºæ—¶é•¿):
        """ç”Ÿæˆç¯å¢ƒåŠ¨æ€æ•ˆæœæç¤ºè¯"""
        if not ç¯å¢ƒæ•ˆæœ or ç¯å¢ƒæ•ˆæœ == "æ— ":
            return ""
        
        # ä»å¸¸é‡é…ç½®ä¸­è·å–ç¯å¢ƒæ•ˆæœæè¿°
        æ•ˆæœæè¿° = DYNAMIC_EFFECT_DESCRIPTIONS.get(ç¯å¢ƒæ•ˆæœ, ç¯å¢ƒæ•ˆæœ)
        
        # è·å–å¼ºåº¦æè¿°ï¼ˆä½¿ç”¨å¸¸é‡é…ç½®ï¼‰
        å¼ºåº¦æè¿° = self._get_intensity_description(æ•ˆæœå¼ºåº¦)
        
        # æ ¼å¼åŒ–æ—¶é•¿æè¿°
        æ—¶é•¿æ ¼å¼åŒ– = f"{è½¬åœºæ—¶é•¿:.1f}"
        
        # ç”Ÿæˆç¯å¢ƒæ•ˆæœæç¤ºè¯
        return f"è¿‡ç¨‹ä¸­ä¼´éšç€{æ•ˆæœæè¿°}ï¼Œ{å¼ºåº¦æè¿°}ï¼ŒæŒç»­çº¦{æ—¶é•¿æ ¼å¼åŒ–}ç§’"

    def _generate_technical_note_enhanced(self, ä¸»è¦æ–¹å¼, æ—¶é•¿, å¹³æ»‘åº¦, èŠ‚å¥, è¿è´¯æ€§, 
                                        é¦–å¸§ä¸»ä½“, å°¾å¸§ä¸»ä½“, äººç‰©å˜åŒ–ç±»å‹="", 
                                        è¿é•œæ–¹å¼="", äººç‰©æ•ˆæœ="æ— ", äººç‰©å¼ºåº¦="", 
                                        ç¯å¢ƒæ•ˆæœ="æ— ", ç¯å¢ƒå¼ºåº¦="", å‰æ™¯é®æŒ¡ç‰©="", å±•å¼€æ–¹å¼=""):
        """ç”ŸæˆæŠ€æœ¯è¯´æ˜ï¼ˆå¢å¼ºç‰ˆï¼‰"""
        æŠ€æœ¯è¦ç‚¹ = []
        
        if ä¸»è¦æ–¹å¼ and ä¸»è¦æ–¹å¼ != "æ— ":
            # æ ¼å¼åŒ–æ—¶é•¿ï¼Œä¿ç•™ä¸€ä½å°æ•°
            æ—¶é•¿æ ¼å¼åŒ– = f"{æ—¶é•¿:.1f}"
            æŠ€æœ¯è¦ç‚¹.append(f"è½¬åœºæ—¶é•¿: {æ—¶é•¿æ ¼å¼åŒ–}ç§’")
            æŠ€æœ¯è¦ç‚¹.append(f"è¿åŠ¨è´¨é‡: {å¹³æ»‘åº¦}")
            æŠ€æœ¯è¦ç‚¹.append(f"èŠ‚å¥æ§åˆ¶: {èŠ‚å¥}")
        
        # è§†è§‰è¿è´¯æ€§ä¿¡æ¯
        if è¿è´¯æ€§ and è¿è´¯æ€§ != "æ— ":
            æŠ€æœ¯è¦ç‚¹.append(f"è§†è§‰è¿è´¯æ€§: {è¿è´¯æ€§}")
        
        # è¿é•œæ–¹å¼ä¿¡æ¯ï¼ˆä»…åœ¨éè¿é•œè½¬åœºæ—¶æ˜¾ç¤ºï¼‰
        if (ä¸»è¦æ–¹å¼ != "è¿é•œæç¤ºè¯è½¬åœº" and 
            è¿é•œæ–¹å¼ and 
            è¿é•œæ–¹å¼ != "æ— "):
            æŠ€æœ¯è¦ç‚¹.append(f"é™„åŠ è¿é•œ: {è¿é•œæ–¹å¼}")
        
        # äººç‰©åŠ¨æ€æ•ˆæœä¿¡æ¯
        if äººç‰©æ•ˆæœ and äººç‰©æ•ˆæœ != "æ— ":
            æŠ€æœ¯è¦ç‚¹.append(f"äººç‰©æ•ˆæœ: {äººç‰©æ•ˆæœ}")
            if äººç‰©å¼ºåº¦:
                æŠ€æœ¯è¦ç‚¹.append(f"äººç‰©å¼ºåº¦: {äººç‰©å¼ºåº¦}")
        
        # ç¯å¢ƒåŠ¨æ€æ•ˆæœä¿¡æ¯
        if ç¯å¢ƒæ•ˆæœ and ç¯å¢ƒæ•ˆæœ != "æ— ":
            æŠ€æœ¯è¦ç‚¹.append(f"ç¯å¢ƒæ•ˆæœ: {ç¯å¢ƒæ•ˆæœ}")
            if ç¯å¢ƒå¼ºåº¦:
                æŠ€æœ¯è¦ç‚¹.append(f"ç¯å¢ƒå¼ºåº¦: {ç¯å¢ƒå¼ºåº¦}")
        
        # å‰æ™¯é®æŒ¡ç‰©ä¿¡æ¯ï¼ˆå¦‚æœæä¾›äº†ï¼‰
        if å‰æ™¯é®æŒ¡ç‰©:
            æŠ€æœ¯è¦ç‚¹.append(f"å‰æ™¯é®æŒ¡ç‰©: {å‰æ™¯é®æŒ¡ç‰©}")
        
        # å±•å¼€æ–¹å¼ä¿¡æ¯ï¼ˆå¦‚æœæ˜¯ç”»å·å±•å¼€å¼è½¬åœºï¼‰
        if ä¸»è¦æ–¹å¼ == "ç”»å·å±•å¼€å¼è½¬åœº" and å±•å¼€æ–¹å¼:
            æŠ€æœ¯è¦ç‚¹.append(f"å±•å¼€æ–¹å¼: {å±•å¼€æ–¹å¼}")
        
        # æ–°å¢ä¸»ä½“ä¿¡æ¯ï¼ˆå¦‚æœä¸»ä½“ä¸æ˜¯é»˜è®¤å€¼ï¼‰
        if é¦–å¸§ä¸»ä½“ and é¦–å¸§ä¸»ä½“ != "å›¾åƒ1ä¸»ä½“":
            æŠ€æœ¯è¦ç‚¹.append(f"é¦–å¸§ä¸»ä½“: {é¦–å¸§ä¸»ä½“}")
        if å°¾å¸§ä¸»ä½“ and å°¾å¸§ä¸»ä½“ != "å›¾åƒ2ä¸»ä½“":
            æŠ€æœ¯è¦ç‚¹.append(f"å°¾å¸§ä¸»ä½“: {å°¾å¸§ä¸»ä½“}")
        
        # äººç‰©å˜åŒ–ç±»å‹ä¿¡æ¯
        if ä¸»è¦æ–¹å¼ == "äººç‰©åˆ°äººç‰©å˜åŒ–" and äººç‰©å˜åŒ–ç±»å‹ and äººç‰©å˜åŒ–ç±»å‹ != "æ— ":
            æŠ€æœ¯è¦ç‚¹.append(f"å˜åŒ–ç±»å‹: {äººç‰©å˜åŒ–ç±»å‹}")
        
        if ä¸»è¦æ–¹å¼ in ["è¿é•œæç¤ºè¯è½¬åœº", "è¿åŠ¨åŒ¹é…è½¬åœº"]:
            æŠ€æœ¯è¦ç‚¹.append("å»ºè®®ä½¿ç”¨ä¸€è‡´çš„æ‘„åƒæœºè¿åŠ¨å‚æ•°")
        
        if ä¸»è¦æ–¹å¼ == "äº¤å‰æº¶è§£è½¬åœº":
            æŠ€æœ¯è¦ç‚¹.append("ç¡®ä¿é¦–å°¾å¸§è‰²å½©å’Œå…‰ç…§é£æ ¼ä¸€è‡´")
        
        if ä¸»è¦æ–¹å¼ == "å½¢æ€å˜å½¢è½¬åœº":
            æŠ€æœ¯è¦ç‚¹.append("éœ€è¦ç›¸ä¼¼çš„ä¸»ä½“å½¢çŠ¶ä»¥è·å¾—æœ€ä½³æ•ˆæœ")
        
        if ä¸»è¦æ–¹å¼ in ["ä¸»ä½“å˜å½¢è½¬åœº", "ä¸»ä½“é®æŒ¡è½¬åœº"]:
            æŠ€æœ¯è¦ç‚¹.append("éœ€è¦æ¸…æ™°çš„ä¸»ä½“å®šä¹‰")
        
        if ä¸»è¦æ–¹å¼ == "äººç‰©åˆ°äººç‰©å˜åŒ–":
            æŠ€æœ¯è¦ç‚¹.append("ä¿æŒäººç‰©æ¯”ä¾‹å’Œå§¿æ€çš„ä¸€è‡´æ€§")
        
        if ä¸»è¦æ–¹å¼ == "ç”»å·å±•å¼€å¼è½¬åœº":
            æŠ€æœ¯è¦ç‚¹.append("ç¡®ä¿å±•å¼€åŠ¨ä½œä¸ç”»é¢è¿‡æ¸¡åŒæ­¥")
        
        return " | ".join(æŠ€æœ¯è¦ç‚¹) if æŠ€æœ¯è¦ç‚¹ else "æ— ç‰¹æ®ŠæŠ€æœ¯è¦æ±‚"


class è§†é¢‘è¿é•œæç¤ºè¯:
    @classmethod
    def INPUT_TYPES(cls):
        return {
            "required": {
                "è¿é•œæ–¹å¼": (CAMERA_MOVEMENTS, {
                    "default": "æ¨è¿‘é•œå¤´",
                    "display_name": "è¿é•œæ–¹å¼"
                }),
                "é•œå¤´ç›®æ ‡": ("STRING", {
                    "multiline": False,
                    "default": "ä¸»ä½“",
                    "display_name": "é•œå¤´ç›®æ ‡"
                }),
                "è¿é•œé€Ÿåº¦": (["ææ…¢é€Ÿ", "æ…¢é€Ÿ", "ä¸­é€Ÿ", "å¿«é€Ÿ", "æå¿«é€Ÿ"], {
                    "default": "ä¸­é€Ÿ",
                    "display_name": "è¿é•œé€Ÿåº¦"
                }),
                "è¿é•œæ—¶é•¿": ("FLOAT", {
                    "default": 3.0, 
                    "min": 1.0, 
                    "max": 10.0, 
                    "step": 0.1,  # æ­¥è¿›ä¹Ÿæ”¹ä¸º0.1ä»¥ä¿æŒä¸€è‡´
                    "display": "slider",
                    "display_name": "è¿é•œæ—¶é•¿(ç§’)"
                }),
            },
            "optional": {
                "ç”»é¢åŠ¨æ€æè¿°": ("STRING", {
                    "multiline": False,
                    "default": "åŠ¨ä½œæµç•…",
                    "display_name": "ç”»é¢åŠ¨æ€æè¿°"
                }),
            }
        }
    
    RETURN_TYPES = ("STRING", "STRING")
    RETURN_NAMES = ("è¿é•œæç¤ºè¯", "æŠ€æœ¯è¯´æ˜")
    FUNCTION = "ç”Ÿæˆè¿é•œæç¤ºè¯"
    CATEGORY = "ğŸ“•æç¤ºè¯å…¬å¼/å›¾è½¬è§†é¢‘"

    def ç”Ÿæˆè¿é•œæç¤ºè¯(self, è¿é•œæ–¹å¼, é•œå¤´ç›®æ ‡, è¿é•œé€Ÿåº¦, è¿é•œæ—¶é•¿, ç”»é¢åŠ¨æ€æè¿°=""):
        
        try:
            # æ¸…ç†è¾“å…¥æ–‡æœ¬
            é•œå¤´ç›®æ ‡_æ¸…ç† = clean_text(é•œå¤´ç›®æ ‡) or "ä¸»ä½“"
            é™„åŠ æè¿°_æ¸…ç† = clean_text(ç”»é¢åŠ¨æ€æè¿°)
            
            # æ ¼å¼åŒ–æ—¶é•¿ï¼Œä¿ç•™ä¸€ä½å°æ•°
            è¿é•œæ—¶é•¿æ ¼å¼åŒ– = f"{è¿é•œæ—¶é•¿:.1f}"
            
            # ç”ŸæˆåŸºç¡€è¿é•œæç¤ºè¯
            åŸºç¡€è¿é•œæç¤ºè¯ = self._generate_camera_movement_prompt(
                è¿é•œæ–¹å¼, é•œå¤´ç›®æ ‡_æ¸…ç†, è¿é•œé€Ÿåº¦, è¿é•œæ—¶é•¿æ ¼å¼åŒ–
            )
            
            # ç”Ÿæˆå®Œæ•´æç¤ºè¯ï¼šå°†ç”»é¢åŠ¨æ€æè¿°æ”¾åœ¨å‰é¢
            if é™„åŠ æè¿°_æ¸…ç† and åŸºç¡€è¿é•œæç¤ºè¯:
                è¿é•œæç¤ºè¯ = f"{é™„åŠ æè¿°_æ¸…ç†}ï¼Œ{åŸºç¡€è¿é•œæç¤ºè¯}"
            elif é™„åŠ æè¿°_æ¸…ç†:
                è¿é•œæç¤ºè¯ = é™„åŠ æè¿°_æ¸…ç†
            else:
                è¿é•œæç¤ºè¯ = åŸºç¡€è¿é•œæç¤ºè¯
            
            # ç”ŸæˆæŠ€æœ¯è¯´æ˜
            æŠ€æœ¯è¯´æ˜ = self._generate_technical_note(
                è¿é•œæ–¹å¼, è¿é•œé€Ÿåº¦, è¿é•œæ—¶é•¿æ ¼å¼åŒ–
            )
            
            return (è¿é•œæç¤ºè¯, æŠ€æœ¯è¯´æ˜)
            
        except Exception as e:
            logging.error(f"è§†é¢‘è¿é•œæç¤ºè¯ç”Ÿæˆé”™è¯¯: {str(e)}")
            error_msg = f"ç”Ÿæˆè¿é•œæç¤ºè¯æ—¶å‡ºé”™: {str(e)}"
            return (error_msg, error_msg)

    def _generate_camera_movement_prompt(self, è¿é•œæ–¹å¼, é•œå¤´ç›®æ ‡, é€Ÿåº¦, æ—¶é•¿):
        """ç”Ÿæˆè¿é•œæç¤ºè¯"""
        if not è¿é•œæ–¹å¼ or è¿é•œæ–¹å¼ == "æ— ":
            return ""
            
        # è·å–åŸºç¡€è¿é•œæè¿°
        movement_desc = CAMERA_MOVEMENT_DESCRIPTIONS.get(è¿é•œæ–¹å¼, "")
        if not movement_desc:
            return f"{è¿é•œæ–¹å¼}ï¼Œå†æ—¶{æ—¶é•¿}ç§’"
        
        # æ›¿æ¢ç›®æ ‡å ä½ç¬¦
        movement_desc = movement_desc.replace("{target}", é•œå¤´ç›®æ ‡)
        
        # æ·»åŠ é€Ÿåº¦å’Œæ—¶é•¿ä¿¡æ¯
        é€Ÿåº¦æè¿° = self._get_speed_description(é€Ÿåº¦)
        
        return f"{movement_desc}ï¼Œ{é€Ÿåº¦æè¿°}ï¼Œå†æ—¶{æ—¶é•¿}ç§’"

    def _get_speed_description(self, é€Ÿåº¦):
        """è·å–é€Ÿåº¦æè¿°"""
        é€Ÿåº¦æè¿°æ˜ å°„ = {
            "ææ…¢é€Ÿ": "æå…¶ç¼“æ…¢å¹³ç¨³",
            "æ…¢é€Ÿ": "ç¼“æ…¢å¹³ç¨³", 
            "ä¸­é€Ÿ": "é€Ÿåº¦é€‚ä¸­",
            "å¿«é€Ÿ": "å¿«é€Ÿæµç•…",
            "æå¿«é€Ÿ": "æé€Ÿè¿…çŒ›"
        }
        return é€Ÿåº¦æè¿°æ˜ å°„.get(é€Ÿåº¦, "é€Ÿåº¦é€‚ä¸­")

    def _generate_technical_note(self, è¿é•œæ–¹å¼, è¿é•œé€Ÿåº¦, è¿é•œæ—¶é•¿):
        """ç”ŸæˆæŠ€æœ¯è¯´æ˜"""
        æŠ€æœ¯è¦ç‚¹ = []
        
        if è¿é•œæ–¹å¼ and è¿é•œæ–¹å¼ != "æ— ":
            æŠ€æœ¯è¦ç‚¹.append(f"è¿é•œæ–¹å¼: {è¿é•œæ–¹å¼}")
            æŠ€æœ¯è¦ç‚¹.append(f"è¿é•œé€Ÿåº¦: {è¿é•œé€Ÿåº¦}")
            æŠ€æœ¯è¦ç‚¹.append(f"è¿é•œæ—¶é•¿: {è¿é•œæ—¶é•¿}ç§’")
        
        # æ ¹æ®è¿é•œæ–¹å¼æä¾›ç‰¹å®šå»ºè®®
        if è¿é•œæ–¹å¼ in ["æ¨è¿‘é•œå¤´", "æ‹‰è¿œé•œå¤´", "å¿«é€Ÿæ¨è¿‘", "å¿«é€Ÿæ‹‰è¿œ"]:
            æŠ€æœ¯è¦ç‚¹.append("æ³¨æ„ç„¦ç‚¹å¹³æ»‘è½¬ç§»")
        
        if è¿é•œæ–¹å¼ in ["æ°´å¹³ç¯ç»•", "åŸåœ°æ—‹è½¬", "ä¿¯è§†æ—‹è½¬"]:
            æŠ€æœ¯è¦ç‚¹.append("ä¿æŒä¸»ä½“åœ¨ç”»é¢ä¸­å¿ƒ")
        
        if è¿é•œæ–¹å¼ in ["é•œå¤´æŠ–åŠ¨", "å†²å‡»éœ‡åŠ¨"]:
            æŠ€æœ¯è¦ç‚¹.append("æ§åˆ¶æŠ–åŠ¨å¹…åº¦é¿å…è¿‡åº¦")
        
        return " | ".join(æŠ€æœ¯è¦ç‚¹) if æŠ€æœ¯è¦ç‚¹ else "æ— ç‰¹æ®ŠæŠ€æœ¯è¦æ±‚"


class è§†é¢‘åŠ¨æ•ˆæç¤ºè¯:
    @classmethod
    def INPUT_TYPES(cls):
        return {
            "required": {
                "åŸºç¡€æè¿°": ("STRING", {
                    "multiline": True,
                    "default": "ä¸€ä¸ªç¾ä¸½çš„åœºæ™¯",
                    "display_name": "åŸºç¡€æè¿°"
                }),
                "äººç‰©åŠ¨æ€æ•ˆæœ": (CHARACTER_DYNAMIC_EFFECTS, {
                    "default": "æ— ",
                    "display_name": "äººç‰©åŠ¨æ€æ•ˆæœ"
                }),
                "ç¯å¢ƒåŠ¨æ€æ•ˆæœ": (ENVIRONMENT_DYNAMIC_EFFECTS, {
                    "default": "æ— ",
                    "display_name": "ç¯å¢ƒåŠ¨æ€æ•ˆæœ"
                }),
                "é•œå¤´ç‰¹æ•ˆ": (CAMERA_EFFECTS, {
                    "default": "æ— ",
                    "display_name": "é•œå¤´ç‰¹æ•ˆ"
                }),
                "ç‰©ç†æ•ˆæœ": (PHYSICS_EFFECTS, {
                    "default": "æ— ",
                    "display_name": "ç‰©ç†æ•ˆæœ"
                }),
                "æ•ˆæœå¼ºåº¦": (EFFECT_INTENSITY, {
                    "default": "æµç•…",
                    "display_name": "æ•ˆæœå¼ºåº¦"
                }),
                "æ•ˆæœæ—¶é•¿": (EFFECT_DURATION, {
                    "default": "ä¸­ç­‰",
                    "display_name": "æ•ˆæœæ—¶é•¿"
                }),
            },
            "optional": {
                "é™„åŠ åŠ¨æ€æè¿°": ("STRING", {
                    "multiline": True,
                    "default": "",
                    "display_name": "é™„åŠ åŠ¨æ€æè¿°"
                }),
                "åŠ¨æ€ç›®æ ‡å¯¹è±¡": ("STRING", {
                    "multiline": False,
                    "default": "",
                    "display_name": "åŠ¨æ€ç›®æ ‡å¯¹è±¡"
                }),
            }
        }
    
    RETURN_TYPES = ("STRING", "STRING", "STRING")
    RETURN_NAMES = ("åŠ¨æ•ˆæç¤ºè¯", "å®Œæ•´æç¤ºè¯", "æŠ€æœ¯è¯´æ˜")
    FUNCTION = "ç”ŸæˆåŠ¨æ•ˆæç¤ºè¯"
    CATEGORY = "ğŸ“•æç¤ºè¯å…¬å¼/å›¾è½¬è§†é¢‘"

    def ç”ŸæˆåŠ¨æ•ˆæç¤ºè¯(self, åŸºç¡€æè¿°, äººç‰©åŠ¨æ€æ•ˆæœ, ç¯å¢ƒåŠ¨æ€æ•ˆæœ, é•œå¤´ç‰¹æ•ˆ, ç‰©ç†æ•ˆæœ,
                    æ•ˆæœå¼ºåº¦, æ•ˆæœæ—¶é•¿, é™„åŠ åŠ¨æ€æè¿°="", åŠ¨æ€ç›®æ ‡å¯¹è±¡=""):
        
        try:
            # æ¸…ç†è¾“å…¥æ–‡æœ¬
            åŸºç¡€æè¿°_æ¸…ç† = clean_text(åŸºç¡€æè¿°)
            é™„åŠ æè¿°_æ¸…ç† = clean_text(é™„åŠ åŠ¨æ€æè¿°)
            ç›®æ ‡å¯¹è±¡_æ¸…ç† = clean_text(åŠ¨æ€ç›®æ ‡å¯¹è±¡)
            
            # ç”ŸæˆåŠ¨æ•ˆæç¤ºè¯
            åŠ¨æ•ˆæç¤ºè¯ = self._generate_dynamic_effects_prompt(
                äººç‰©åŠ¨æ€æ•ˆæœ, ç¯å¢ƒåŠ¨æ€æ•ˆæœ, é•œå¤´ç‰¹æ•ˆ, ç‰©ç†æ•ˆæœ,
                æ•ˆæœå¼ºåº¦, æ•ˆæœæ—¶é•¿, ç›®æ ‡å¯¹è±¡_æ¸…ç†
            )
            
            # ç”Ÿæˆå®Œæ•´æç¤ºè¯
            å®Œæ•´æç¤ºè¯ = self._generate_full_prompt(
                åŸºç¡€æè¿°_æ¸…ç†, åŠ¨æ•ˆæç¤ºè¯, é™„åŠ æè¿°_æ¸…ç†
            )
            
            # ç”ŸæˆæŠ€æœ¯è¯´æ˜
            æŠ€æœ¯è¯´æ˜ = self._generate_technical_note(
                äººç‰©åŠ¨æ€æ•ˆæœ, ç¯å¢ƒåŠ¨æ€æ•ˆæœ, é•œå¤´ç‰¹æ•ˆ, ç‰©ç†æ•ˆæœ,
                æ•ˆæœå¼ºåº¦, æ•ˆæœæ—¶é•¿
            )
            
            return (åŠ¨æ•ˆæç¤ºè¯, å®Œæ•´æç¤ºè¯, æŠ€æœ¯è¯´æ˜)
            
        except Exception as e:
            logging.error(f"è§†é¢‘åŠ¨æ•ˆæç¤ºè¯ç”Ÿæˆé”™è¯¯: {str(e)}")
            error_msg = f"ç”ŸæˆåŠ¨æ•ˆæç¤ºè¯æ—¶å‡ºé”™: {str(e)}"
            return (error_msg, error_msg, error_msg)

    def _generate_dynamic_effects_prompt(self, äººç‰©æ•ˆæœ, ç¯å¢ƒæ•ˆæœ, é•œå¤´æ•ˆæœ, ç‰©ç†æ•ˆæœ,
                                      å¼ºåº¦, æ—¶é•¿, ç›®æ ‡å¯¹è±¡):
        """ç”ŸæˆåŠ¨æ€æ•ˆæœæç¤ºè¯"""
        æ•ˆæœç»„ä»¶ = []
        
        # å¤„ç†äººç‰©åŠ¨æ€æ•ˆæœ
        if äººç‰©æ•ˆæœ and äººç‰©æ•ˆæœ != "æ— ":
            äººç‰©æè¿° = DYNAMIC_EFFECT_DESCRIPTIONS.get(äººç‰©æ•ˆæœ, äººç‰©æ•ˆæœ)
            if ç›®æ ‡å¯¹è±¡:
                äººç‰©æè¿° = f"{ç›®æ ‡å¯¹è±¡}{äººç‰©æè¿°}"
            æ•ˆæœç»„ä»¶.append(äººç‰©æè¿°)
        
        # å¤„ç†ç¯å¢ƒåŠ¨æ€æ•ˆæœ
        if ç¯å¢ƒæ•ˆæœ and ç¯å¢ƒæ•ˆæœ != "æ— ":
            ç¯å¢ƒæè¿° = DYNAMIC_EFFECT_DESCRIPTIONS.get(ç¯å¢ƒæ•ˆæœ, ç¯å¢ƒæ•ˆæœ)
            æ•ˆæœç»„ä»¶.append(ç¯å¢ƒæè¿°)
        
        # å¤„ç†é•œå¤´ç‰¹æ•ˆ
        if é•œå¤´æ•ˆæœ and é•œå¤´æ•ˆæœ != "æ— ":
            é•œå¤´æè¿° = DYNAMIC_EFFECT_DESCRIPTIONS.get(é•œå¤´æ•ˆæœ, é•œå¤´æ•ˆæœ)
            æ•ˆæœç»„ä»¶.append(é•œå¤´æè¿°)
        
        # å¤„ç†ç‰©ç†æ•ˆæœ
        if ç‰©ç†æ•ˆæœ and ç‰©ç†æ•ˆæœ != "æ— ":
            ç‰©ç†æè¿° = DYNAMIC_EFFECT_DESCRIPTIONS.get(ç‰©ç†æ•ˆæœ, ç‰©ç†æ•ˆæœ)
            æ•ˆæœç»„ä»¶.append(ç‰©ç†æè¿°)
        
        # å¦‚æœæ²¡æœ‰é€‰æ‹©ä»»ä½•æ•ˆæœï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²
        if not æ•ˆæœç»„ä»¶:
            return ""
        
        # ç»„åˆæ‰€æœ‰æ•ˆæœ
        æ•ˆæœæ–‡æœ¬ = "ï¼Œ".join(æ•ˆæœç»„ä»¶)
        
        # æ·»åŠ å¼ºåº¦å’Œæ—¶é•¿æè¿°
        å¼ºåº¦æè¿° = self._get_intensity_description(å¼ºåº¦)
        æ—¶é•¿æè¿° = self._get_duration_description(æ—¶é•¿)
        
        return f"{æ•ˆæœæ–‡æœ¬}ï¼Œ{å¼ºåº¦æè¿°}ï¼Œ{æ—¶é•¿æè¿°}"

    def _get_intensity_description(self, å¼ºåº¦):
        """è·å–å¼ºåº¦æè¿°"""
        å¼ºåº¦æè¿°æ˜ å°„ = {
            "è½»å¾®": "æ•ˆæœè½»å¾®è‡ªç„¶",
            "é€‚ä¸­": "æ•ˆæœé€‚ä¸­æ˜æ˜¾", 
            "æµç•…": "æ•ˆæœåŠ¨ä½œæµç•…", 
            "å¼ºçƒˆ": "æ•ˆæœå¼ºçƒˆçªå‡º",
            "éå¸¸å¼ºçƒˆ": "æ•ˆæœéå¸¸å¼ºçƒˆéœ‡æ’¼"
        }
        return å¼ºåº¦æè¿°æ˜ å°„.get(å¼ºåº¦, "æ•ˆæœé€‚ä¸­")

    def _get_duration_description(self, æ—¶é•¿):
        """è·å–æ—¶é•¿æè¿°"""
        æ—¶é•¿æè¿°æ˜ å°„ = {
            "çŸ­æš‚": "æŒç»­æ—¶é—´çŸ­æš‚",
            "ä¸­ç­‰": "æŒç»­æ—¶é—´é€‚ä¸­",
            "æŒä¹…": "æ•ˆæœæŒä¹…ç¨³å®š", 
            "å¾ªç¯æŒç»­": "æ•ˆæœå¾ªç¯æŒç»­"
        }
        return æ—¶é•¿æè¿°æ˜ å°„.get(æ—¶é•¿, "æŒç»­æ—¶é—´é€‚ä¸­")

    def _generate_full_prompt(self, åŸºç¡€æè¿°, åŠ¨æ•ˆæç¤ºè¯, é™„åŠ æè¿°):
        """ç”Ÿæˆå®Œæ•´æç¤ºè¯"""
        ç»„ä»¶ = []
        
        if åŸºç¡€æè¿°:
            ç»„ä»¶.append(åŸºç¡€æè¿°)
        
        # å¤„ç†åŠ¨æ•ˆæç¤ºè¯
        if åŠ¨æ•ˆæç¤ºè¯:
            ç»„ä»¶.append(åŠ¨æ•ˆæç¤ºè¯)
        
        if é™„åŠ æè¿°:
            ç»„ä»¶.append(é™„åŠ æè¿°)
        
        # å¦‚æœæ‰€æœ‰ç»„ä»¶éƒ½ä¸ºç©ºï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²
        if not ç»„ä»¶:
            return ""
        
        å®Œæ•´æç¤ºè¯ = "ï¼Œ".join(ç»„ä»¶)
        
        # æœ€ç»ˆæ¸…ç†
        å®Œæ•´æç¤ºè¯ = re.sub(r',\s+,', ',', å®Œæ•´æç¤ºè¯)
        å®Œæ•´æç¤ºè¯ = re.sub(r'\s+', ' ', å®Œæ•´æç¤ºè¯).strip()
        
        return å®Œæ•´æç¤ºè¯

    def _generate_technical_note(self, äººç‰©æ•ˆæœ, ç¯å¢ƒæ•ˆæœ, é•œå¤´æ•ˆæœ, ç‰©ç†æ•ˆæœ, å¼ºåº¦, æ—¶é•¿):
        """ç”ŸæˆæŠ€æœ¯è¯´æ˜"""
        æŠ€æœ¯è¦ç‚¹ = []
        
        # æ·»åŠ é€‰æ‹©çš„æ•ˆæœä¿¡æ¯
        æœ‰æ•ˆæ•ˆæœ = []
        if äººç‰©æ•ˆæœ != "æ— ":
            æœ‰æ•ˆæ•ˆæœ.append(f"äººç‰©:{äººç‰©æ•ˆæœ}")
        if ç¯å¢ƒæ•ˆæœ != "æ— ":
            æœ‰æ•ˆæ•ˆæœ.append(f"ç¯å¢ƒ:{ç¯å¢ƒæ•ˆæœ}")
        if é•œå¤´æ•ˆæœ != "æ— ":
            æœ‰æ•ˆæ•ˆæœ.append(f"é•œå¤´:{é•œå¤´æ•ˆæœ}")
        if ç‰©ç†æ•ˆæœ != "æ— ":
            æœ‰æ•ˆæ•ˆæœ.append(f"ç‰©ç†:{ç‰©ç†æ•ˆæœ}")
        
        if æœ‰æ•ˆæ•ˆæœ:
            æŠ€æœ¯è¦ç‚¹.append(" | ".join(æœ‰æ•ˆæ•ˆæœ))
        
        # æ·»åŠ å¼ºåº¦å’Œæ—¶é•¿ä¿¡æ¯
        æŠ€æœ¯è¦ç‚¹.append(f"å¼ºåº¦:{å¼ºåº¦}")
        æŠ€æœ¯è¦ç‚¹.append(f"æ—¶é•¿:{æ—¶é•¿}")
        
        # æ ¹æ®æ•ˆæœç±»å‹æä¾›ç‰¹å®šå»ºè®®
        if äººç‰©æ•ˆæœ != "æ— ":
            æŠ€æœ¯è¦ç‚¹.append("ç¡®ä¿äººç‰©åŠ¨ä½œè‡ªç„¶æµç•…")
        
        if ç¯å¢ƒæ•ˆæœ != "æ— ":
            æŠ€æœ¯è¦ç‚¹.append("ç¯å¢ƒæ•ˆæœä¸åœºæ™¯åè°ƒ")
        
        if é•œå¤´æ•ˆæœ != "æ— ":
            æŠ€æœ¯è¦ç‚¹.append("é•œå¤´è¿åŠ¨å¹³æ»‘ç¨³å®š")
        
        if ç‰©ç†æ•ˆæœ != "æ— ":
            æŠ€æœ¯è¦ç‚¹.append("ç‰©ç†æ•ˆæœç¬¦åˆçœŸå®è§„å¾‹")
        
        return " | ".join(æŠ€æœ¯è¦ç‚¹) if æŠ€æœ¯è¦ç‚¹ else "æ— åŠ¨æ€æ•ˆæœé…ç½®"